<databaseChangeLog xmlns="http://www.liquibase.org/xml/ns/dbchangelog"
                   xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
                   xsi:schemaLocation="http://www.liquibase.org/xml/ns/dbchangelog http://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-3.5.xsd"
                   objectQuotingStrategy="QUOTE_ALL_OBJECTS"
                   logicalFilePath="serbsky/user.xml">
<changeSet id="serbsky/user/data" author="e.upatov" context="SERBSKY">
    <comment>Создание дополнительных пользователей</comment>
    <sql dbms="mysql">
        SET @currentUserAccessLevel=(SELECT id FROM rbUserAccessLevel WHERE level = 1);
        SET @maxUserAccessLevel=(SELECT id FROM rbUserAccessLevel WHERE level = 5);
    </sql>
    <loadData tableName="user" file="data/user.csv" relativeToChangelogFile="true" encoding="UTF-8" separator="," quotchar="'">
        <column name="currentUserAccessLevel_id" type="COMPUTED"/>
        <column name="maxUserAccessLevel_id" type="COMPUTED"/>
    </loadData>
    <sql>UPDATE user SET password = MD5(login) WHERE password IS NULL;</sql>
    <sql>
        INSERT INTO mmUserToRole (user_id, role_id)
        SELECT u.id, r.id
        FROM user u
        INNER JOIN rbRole r ON r.code = 'EMPLOYER'
        WHERE u.login != 'admin'
    </sql>
</changeSet>
</databaseChangeLog>