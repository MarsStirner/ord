<databaseChangeLog xmlns="http://www.liquibase.org/xml/ns/dbchangelog"
                   xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
                   xsi:schemaLocation="http://www.liquibase.org/xml/ns/dbchangelog http://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-3.5.xsd"
                   logicalFilePath="init/task.xml"
                   objectQuotingStrategy="QUOTE_ALL_OBJECTS">
    <property name="table.name" value="task" global="false"/>
    <property name="table.comment" value="Задачи" global="false"/>

    <property name="prefix.changeSetId" value="init/${table.name}" global="false"/>
    <property name="prefix.FK" value="FK_${table.name}" global="false"/>

    <changeSet id="${prefix.changeSetId}" author="e.upatov">
        <comment>${table.comment}</comment>
        <createTable tableName="${table.name}" remarks="${table.comment}">
            <column autoIncrement="true" name="id" type="INT(10)">
                <constraints primaryKey="true"/>
            </column>
            <column name="creationDate" remarks="Дата создания" type="datetime">
                <constraints nullable="false"/>
            </column>
            <column name="author_id" remarks="Автор документа" type="INT(10)">
                <constraints nullable="false" foreignKeyName="${prefix.FK}__author" referencedTableName="user" referencedColumnNames="id"/>
            </column>
            <column name="controller_id" remarks="Руководитель по документу" type="INT(10)">-->
                <constraints nullable="true" foreignKeyName="${prefix.FK}__controller" referencedTableName="user" referencedColumnNames="id"/>
            </column>
            <column defaultValueNumeric="0" name="deleted" remarks="Признак удаления" type="BIT(1)">
                <constraints nullable="false"/>
            </column>
            <column name="executionDate" remarks="Крайний срок исполнения" type="datetime"/>
            <column name="registrationDate" remarks="Дата регистрации документа" type="datetime"/>
            <column name="registrationNumber" remarks="Номер документа после регистрации" type="VARCHAR(255)"/>
            <column name="shortDescription" remarks="Краткое описание содержания документа" type="LONGTEXT"/>
            <column name="status_id" remarks="Статус документа" type="INT(10)">
                <constraints nullable="false"/>
            </column>
            <column name="form_id" remarks="Вид документа" type="INT(10)">
                <constraints nullable="false" foreignKeyName="${prefix.FK}__form" referencedTableName="rbDocumentForm" referencedColumnNames="id"/>
            </column>
            <!-- Note отсутвует
            <column name="userAccessLevel_id" remarks="Уровень допуска документа" type="INT(10)">-->
                <!--<constraints nullable="false" foreignKeyName="${prefix.FK}userAccessLevel" referencedTableName="rbUserAccessLevel" referencedColumnNames="id"/>-->
            <!--</column>-->
            <!--Specific fields-->
            <column name="initiator_id" remarks="Инициатор поручения" type="INT(10)">
                <constraints nullable="true" foreignKeyName="${prefix.FK}__initiator" referencedTableName="user" referencedColumnNames="id"/>
            </column>
            <column name="controlDate" type="datetime"/>
            <column name="rootDocumentId" type="VARCHAR(255)"/>
            <column name="erpNumber" type="VARCHAR(255)"/>
            <column name="parent_id" remarks="родительское поручение" type="INT(10)">
                <constraints nullable="true" foreignKeyName="${prefix.FK}__parent" referencedTableName="${table.name}" referencedColumnNames="id"/>
            </column>
        </createTable>
        <modifySql dbms="mysql">
            <append value=" ENGINE = InnoDB "/>
            <append value=" DEFAULT CHARACTER SET = utf8 "/>
        </modifySql>
    </changeSet>

    <!--Индексы к таблице -->
    <changeSet id="${prefix.changeSetId}/index" author="e.upatov">
        <comment>Создание индексов: ${table.comment}</comment>
        <createIndex indexName="IDX_${table.name}__registrationDate" tableName="${table.name}">
            <column name="registrationDate"/>
        </createIndex>
        <createIndex indexName="IDX_${table.name}__registrationNumber" tableName="${table.name}">
            <column name="registrationNumber"/>
        </createIndex>
        <createIndex indexName="IDX_${table.name}__rootDocumentId" tableName="${table.name}">
            <column name="rootDocumentId"/>
        </createIndex>
    </changeSet>
    <!--Факты просмотров-->
    <changeSet id="${prefix.changeSetId}/view_facts" author="e.upatov">
        <comment>Факты просмотров: ${table.comment}</comment>
        <createTable tableName="${table.name}_views" remarks="Факты просмотров: ${table.comment}">
            <column name="document_id" remarks="Идентификатор просмотренного документа" type="INT(10)">
                <constraints foreignKeyName="${prefix.FK}_views__document" referencedTableName="${table.name}" referencedColumnNames="id"/>
            </column>
            <column name="user_id" remarks="Идентификатор пользователя, просмотревшего документ" type="INT(10)">
                <constraints nullable="true" foreignKeyName="${prefix.FK}_views__author" referencedTableName="user" referencedColumnNames="id"/>
            </column>
            <column defaultValueComputed="CURRENT_TIMESTAMP" name="viewDateTime" remarks="Время просмотра документа" type="TIMESTAMP">
                <constraints nullable="false"/>
            </column>
        </createTable>
        <modifySql dbms="mysql">
            <append value=" ENGINE = InnoDB "/>
            <append value=" DEFAULT CHARACTER SET = utf8 "/>
        </modifySql>
    </changeSet>
    <changeSet id="${prefix.changeSetId}/view_facts/primary_key" author="e.upatov">
        <addPrimaryKey tableName="${table.name}_views" columnNames="document_id, user_id" constraintName="PRIMARY"/>
    </changeSet>

    <changeSet id="${prefix.changeSetId}/history" author="e.upatov">
        <comment>История действий: ${table.comment}</comment>
        <createTable tableName="${table.name}_history" remarks="История действий: ${table.comment}">
            <column name="document_id" remarks="Идентификатор документа" type="INT(10)">
                <constraints foreignKeyName="${prefix.FK}_history__document" referencedTableName="${table.name}" referencedColumnNames="id"/>
            </column>
            <column name="entry_id" remarks="Запись в истории" type="INT(10)">
                <constraints nullable="true" foreignKeyName="${prefix.FK}_history__entry" referencedTableName="wf_history" referencedColumnNames="id"/>
            </column>
        </createTable>
        <modifySql dbms="mysql">
            <append value=" ENGINE = InnoDB "/>
            <append value=" DEFAULT CHARACTER SET = utf8 "/>
        </modifySql>
    </changeSet>
    <changeSet id="${prefix.changeSetId}/history/primary_key" author="e.upatov">
        <addPrimaryKey tableName="${table.name}_history" columnNames="document_id, entry_id" constraintName="PRIMARY"/>
    </changeSet>

    <!--Исполнители-->
    <changeSet id="${prefix.changeSetId}/executor" author="e.upatov">
        <comment>Таблица-связка: ${table.comment} с Исполнителями</comment>
        <createTable tableName="${table.name}_executor" remarks="Таблица-связка: ${table.comment} с Исполнителями">
            <column name="document_id" remarks="Идентификатор документа" type="INT(10)">
                <constraints foreignKeyName="${prefix.FK}_executor__document" referencedTableName="${table.name}" referencedColumnNames="id"/>
            </column>
            <column name="user_id" remarks="Пользователь" type="INT(10)">
                <constraints nullable="true" foreignKeyName="${prefix.FK}_executor__user" referencedTableName="user" referencedColumnNames="id"/>
            </column>
        </createTable>
        <modifySql dbms="mysql">
            <append value=" ENGINE = InnoDB "/>
            <append value=" DEFAULT CHARACTER SET = utf8 "/>
        </modifySql>
    </changeSet>
    <changeSet id="${prefix.changeSetId}/executor/primary_key" author="e.upatov">
        <addPrimaryKey tableName="${table.name}_executor" columnNames="document_id, user_id" constraintName="PRIMARY"/>
    </changeSet>


</databaseChangeLog>