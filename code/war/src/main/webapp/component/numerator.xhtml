<?xml version='1.0' encoding='UTF-8' ?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
        "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml"
      xmlns:ui="http://java.sun.com/jsf/facelets"
      xmlns:h="http://java.sun.com/jsf/html"
      xmlns:f="http://java.sun.com/jsf/core"
      xmlns:e5ui="http://efive.ru/uitemplates"
      xmlns:e5ui-comp="http://efive.ru/uitemplates/composite"
      xmlns:c="http://java.sun.com/jsp/jstl/core">

<ui:composition template="/WEB-INF/jsf-template/template.xhtml">

<ui:define name="running_head">
    <!-- #{numerator.document.id}  -->
    <e5ui-comp:userSessionUpdate
            rendered="#{numerator.editState or numerator.createState}"
            interval="300"/>
    <h:outputScript library="js" name="datepicker_init_ru.js"
                    target="head"/>
    <e5ui-comp:outputUtilScript/>
</ui:define>

<ui:define name="header">
    <h:panelGroup
            rendered="#{numerator.viewState or numerator.createState or numerator.editState}">
        <div id="form_header">
            <div class="actionbar">
                <div class="menu">
                    <div class="defbutton">
                        <h:commandLink action="#{numerator.edit}"
                                       rendered="#{numerator.viewState}">
                            <h:graphicImage value="#{resource['images:edit_buttn.png']}"/>
                            Редактировать
                        </h:commandLink>
                    </div>
                    <div class="defbutton">
                        <h:commandLink action="#{numerator.save}"
                                       rendered="#{numerator.editState or numerator.createState}">
                            <h:graphicImage value="#{resource['images:save_buttn.png']}"/>
                            Сохранить
                        </h:commandLink>
                    </div>
                    <div class="defbutton">
                        <h:commandLink action="#{numerator.delete()}"
                                       rendered="#{numerator.editState and (numerator.document.getDocumentStatus().getId() eq 1)}">
                            <h:graphicImage value="#{resource['images:dell_buttn.png']}"/>
                            Удалить
                            <f:param name="docAction" value="delete"/>
                        </h:commandLink>
                    </div>
                    <div class="defbutton">
                        <e5ui:formPart id="actions_fp">
                            <h:commandLink
                                    onclick="actionsModal.clickOpen('actionsModal'); return false;"
                                    immediate="true">
                                <h:graphicImage value="#{resource['images:button-do.png']}"/>
                                Действия
                            </h:commandLink>
                            <e5ui-comp:modalWindow id="actionsModal"
                                                   modalWindowHolder="#{numerator.processorModal}"
                                                   render="main_content_form:"
                                                   execute=":main_content_form"
                                                   showButtons="false" widgetVar="actionsModal">
                                <h:panelGroup
                                        rendered="#{not(numerator.processorModal.processingState)}">
                                    <div id="title">Действия</div>
                                </h:panelGroup>
                                <h:panelGroup
                                        rendered="#{numerator.processorModal.actionsAvailable}">
                                    <div class="wrap"
                                         style="height: 120px; background-color: #fff; clear: both;">
                                        <div class="inner" style="height: 120px;">
                                            <e5ui:dataTable id="action_select_table" border="0"
                                                            cellpadding="0" cellspacing="0"
                                                            value="#{numerator.processorModal.availableActions}"
                                                            var="row" grouping="false" width="100%">
                                                <e5ui:row
                                                        onclick="e5ui_util.clickElement(this, 'selectLink$');"
                                                        styleClass="#{numerator.processorModal.selected(row)? 'grid_row_selected': ''}"/>
                                                <e5ui:column>
                                                    <f:facet name="header">
                                                        <p>Доступные действия</p>
                                                    </f:facet>
                                                    <h:outputText value="#{row.action.name}"/>
                                                    <h:commandLink id="selectLink" style="display: none;"
                                                                   rendered="#{not numerator.processorModal.selected(row)}"
                                                                   action="#{numerator.processorModal.select(row)}"/>
                                                </e5ui:column>
                                            </e5ui:dataTable>
                                        </div>
                                    </div>
                                </h:panelGroup>
                                <h:panelGroup
                                        rendered="#{numerator.processorModal.noActionsAvailable or numerator.processorModal.failureState or numerator.processorModal.processedState}">
                                    <h:outputText style="padding-left:10px;"
                                                  value="#{numerator.processorModal.actionResult}"/>
                                </h:panelGroup>
                                <h:panelGroup
                                        rendered="#{numerator.processorModal.processingState}">
                                    <e5ui:include
                                            data="#{numerator.processorModal.processedActivity.document.form}"/>
                                </h:panelGroup>

                                <div class="e5ui-modal-bottombuttons">
                                    <h:commandButton
                                            action="#{numerator.processorModal.process()}"
                                            rendered="#{numerator.processorModal.actionsAvailable or numerator.processorModal.processingState}"
                                            value="Выполнить">
                                    </h:commandButton>
                                    <h:button
                                            rendered="#{numerator.processorModal.actionsAvailable or numerator.processorModal.processingState}"
                                            onclick="actionsModal.clickClose(); return false;"
                                            value="Отмена"/>
                                    <h:button
                                            rendered="#{numerator.processorModal.noActionsAvailable or numerator.processorModal.failureState or numerator.processorModal.processedState}"
                                            onclick="actionsModal.clickClose(); return false;"
                                            value="Закрыть"/>
                                </div>
                            </e5ui-comp:modalWindow>
                        </e5ui:formPart>
                    </div>
                </div>
            </div>

        </div>
    </h:panelGroup>
</ui:define>

<ui:define name="left_menu"></ui:define>

<ui:define name="content">
<div id="header_content">
    <h:panelGroup rendered="#{numerator.createState}">
        <div class="title">
            Новый нумератор
            <h:outputText value="#{numerator.document.getDocumentStatus().getName()}"/>
        </div>
    </h:panelGroup>
    <h:panelGroup
            rendered="#{numerator.editState or numerator.viewState}">
        <div class="name">
            --
            <h:outputText value="#{numerator.document.documentTypeKey}"/>
            -- Нумератор от
            <h:outputText value="#{numerator.document.creationDate}">
                <f:convertDateTime type="date" pattern="dd.MM.yyyy"/>
            </h:outputText>
        </div>
        <div class="title">
            <h:outputText value="#{numerator.document.getDocumentStatus().getName()}"/>
        </div>
    </h:panelGroup>
    <h:panelGroup rendered="#{numerator.notFoundState}">
        <div class="name">404 - Документ не найден</div>
    </h:panelGroup>
    <h:panelGroup rendered="#{numerator.forbiddenState}">
        <div class="name">В доступе отказано. Уровень допуска к
            документу выше вашего уровня допуска.
        </div>
    </h:panelGroup>
    <h:panelGroup
            rendered="#{not(numerator.createState or numerator.editState or numerator.viewState or numerator.notFoundState or numerator.forbiddenState)}">
        <div class="name">В доступе отказано</div>
    </h:panelGroup>
</div>

<div class="main_content">
<e5ui:formPart id="editFormPart"
               rendered="#{numerator.viewState or numerator.createState or numerator.editState}">
<h:panelGroup
        rendered="#{numerator.createState or (numerator.editState and (numerator.document.getDocumentStatus().getId() lt 2))}">
    <div class="row">
        <table class="form_grid">
            <tr class="row">
                <td class="first"><label
                        for="main_content_form:creationDate:dateEditor"> <span
                        class="title">Дата создания</span> </label></td>
                <td class="second"><e5ui-comp:inputDate id="creationDate"
                                                        value="#{numerator.document.creationDate}" lang="ru"
                                                        required="true"/> <e5ui:marker for="creationDate"/>
                </td>
                <td class="third"><label for="main_content_form:author">
                    <span class="title">Автор</span> </label></td>
                <td class="fourth"><h:outputText id="author"
                                                 value="#{numerator.document.author.getFullName()}" lang="ru"/>
                </td>
            </tr>
        </table>
    </div>
</h:panelGroup>
<h:panelGroup
        rendered="#{numerator.viewState or (numerator.editState and (numerator.document.getDocumentStatus().getId() ge 2))}">
    <div class="row">
        <table class="form_grid">
            <tr class="row">
                <td class="first"><label> <span class="title">Дата
											создания</span> </label></td>
                <td class="second"><h:outputText
                        value="#{numerator.document.creationDate}" lang="ru">
                    <f:convertDateTime type="date" pattern="dd.MM.yyyy"/>
                </h:outputText></td>
                <td class="third"><label> <span class="title">Автор:</span>
                </label></td>
                <td class="fourth"><h:outputText
                        value="#{numerator.document.author}"
                        converter="PersonConverter" lang="ru"/>
                </td>
            </tr>
        </table>
    </div>
</h:panelGroup>
<e5ui:tabPanel id="content_table">
<e5ui:tabPage headerText="#{numerator.requisitesTabHeader}"
              actionBehavior="#{numerator.viewState? 'client': 'submit'}"
              selected="#{numerator.requisitesTabSelected}">
<h:panelGroup rendered="#{numerator.viewState}">
    <div class="row">
        <table class="form_grid">
            <tr class="row">
                <td class="first"><label> <span class="title">Индекс:</span>
                </label>
                </td>
                <td class="second"><h:outputText
                        value="#{numerator.document.numeratorIndex}"/></td>
                <td class="third"></td>
                <td class="fourth"></td>
            </tr>
            <tr class="row">
                <td class="first"><label> <span class="title">Формат
													номера:</span> </label>
                </td>
                <td class="second" colspan="3"><h:outputText
                        value="#{numerator.document.numberFormat}"/></td>
            </tr>
            <tr class="row">
                <td class="first"><label> <span class="title">Краткое
													содержание:</span> </label></td>
                <td class="second" colspan="3"><h:inputTextarea rows="6"
                                                                value="#{numerator.document.shortDescription}"
                                                                readonly="true" style="border: 0"/></td>
            </tr>
        </table>
    </div>
</h:panelGroup>
<h:panelGroup
        rendered="#{numerator.createState or numerator.editState}">
    <div class="row">
        <table class="form_grid">
            <tr class="row">
                <td class="first"><label
                        for="main_content_form:numeratorIndex"> <span
                        class="title">Индекс:</span> </label>
                </td>
                <td class="second" colspan="3"><h:inputText
                        id="numeratorIndex"
                        value="#{numerator.document.numeratorIndex}"/>
                </td>
            </tr>
            <tr class="row">
                <td class="first"><label
                        for="main_content_form:numberFormat"> <span
                        class="title">Формат номера:</span> </label>
                </td>
                <td class="second" colspan="3"><h:inputText
                        id="numberFormat" value="#{numerator.document.numberFormat}"
                        lang="ru"/></td>
            </tr>
            <tr class="row">
                <td class="first"><label
                        for="main_content_form:shortDescription"> <span
                        class="title">Краткое содержание:</span> </label></td>
                <td class="second" colspan="3"><h:inputTextarea
                        id="shortDescription" rows="6"
                        value="#{numerator.document.shortDescription}" class="wide"
                        immediate="true"/> <e5ui:marker for="shortDescription"/>
                </td>
            </tr>
            <tr class="row">
                <td class="first"></td>
                <td class="second"></td>
                <td class="third"></td>
                <td class="fourth"></td>
            </tr>
        </table>
    </div>
</h:panelGroup>
<fieldset>
    <legend>Шаблон</legend>
    <h:outputScript>
        function goToDocument(docType, id) {
        if (id != "") {
        if (docType != "") {
        if(docType.indexOf('incoming')!=-1){
        componentType='in/in_document';
        }else if(docType.indexOf('outgoing')!=-1){
        componentType='out/out_document';
        }else if(docType.indexOf('internal')!=-1){
        componentType='internal/internal_document';
        }else if(docType.indexOf('request')!=-1){
        componentType='request/request_document';
        }
        window.open('#{facesContext.externalContext.requestContextPath}/component/'+componentType+'.xhtml?docId=' + id,'_blank');
        }
        }
        }
        }
    </h:outputScript>

    <div class="actionbar">
        <div class="menu">
            <h:panelGroup
                    rendered="#{numerator.document.documentTypeKey eq 'incoming'}">
                <div class="defbutton">
                    <h:outputLink
                            value="#{contextPath}/component/in/in_document.xhtml"
                            target="_blank">
                        <h:graphicImage
                                value="#{resource['images:newf_buttn_icon.png']}"/>
                        Новый шаблон
                        <f:param name="docAction" value="create"/>
                        <f:param name="parentId" value="#{numerator.document.id}"/>
                        <f:param name="isDocumentTemplate" value="yes"/>
                    </h:outputLink>
                </div>
                <div class="defbutton">
                    <h:commandLink action="#{in_template_documents.refresh()}">
                        <f:ajax render=":main_content_form:select_table"/>
                        <h:graphicImage
                                value="#{resource['images:button-refresh.png']}"/>
                        Обновить
                    </h:commandLink>
                </div>

            </h:panelGroup>
            <h:panelGroup
                    rendered="#{numerator.document.documentTypeKey eq 'outgoing'}">
                <div class="defbutton">
                    <h:outputLink
                            value="#{contextPath}/component/out/out_document.xhtml"
                            target="_blank">
                        <h:graphicImage
                                value="#{resource['images:newf_buttn_icon.png']}"/>
                        Новый шаблон
                        <f:param name="docAction" value="create"/>
                        <f:param name="parentId" value="#{numerator.document.id}"/>
                        <f:param name="isDocumentTemplate" value="yes"/>
                    </h:outputLink>
                </div>
            </h:panelGroup>
            <h:panelGroup
                    rendered="#{numerator.document.documentTypeKey eq 'internal'}">
                <div class="defbutton">
                    <h:outputLink
                            value="#{contextPath}/component/internal/internal_document.xhtml"
                            target="_blank">
                        <h:graphicImage
                                value="#{resource['images:newf_buttn_icon.png']}"/>
                        Новый шаблон
                        <f:param name="docAction" value="create"/>
                        <f:param name="parentId" value="#{numerator.document.id}"/>
                        <f:param name="isDocumentTemplate" value="yes"/>
                    </h:outputLink>
                </div>
            </h:panelGroup>
            <h:panelGroup
                    rendered="#{numerator.document.documentTypeKey eq 'request'}">
                <div class="defbutton">
                    <h:outputLink
                            value="#{contextPath}/component/request/request_document.xhtml"
                            target="_blank">
                        <h:graphicImage
                                value="#{resource['images:newf_buttn_icon.png']}"/>
                        Новый шаблон
                        <f:param name="docAction" value="create"/>
                        <f:param name="parentId" value="#{numerator.document.id}"/>
                        <f:param name="isDocumentTemplate" value="yes"/>
                    </h:outputLink>
                </div>
            </h:panelGroup>

        </div>
    </div>
    <h:panelGroup>
        <div id="modal_container" style="margin-top: 0;">
            <div class="wrap"
                 style="height: 250px; width: 100%; margin: 0px;">
                <div class="inner" style="height: 250px;">
                    <e5ui:dataTable id="select_table" border="0" cellpadding="0"
                                    cellspacing="0"
                                    value="#{in_template_documents.getTemplateDocumentsByNumeratorId(String.valueOf(numerator.document.id))}"
                                    var="row" style="width:100%">
                        <e5ui:row
                                ondblclick="goToDocument('#{row.id}','#{numerator.documentTypeKey}');"
                                level="#{row.grouping}" group="#{row.parent}"
                                fullRow="false" collapsed="false">
                            <f:facet name="fullRowDefault">
                                <b><h:outputText value="#{row.registrationNumber}"/> </b>
                            </f:facet>
                        </e5ui:row>
                        <e5ui:column>
                            <f:facet name="header">
                                <p>Дата создания</p>
                            </f:facet>
                            <h:outputText value="#{row.creationDate}">
                                <f:convertDateTime type="date" pattern="dd.MM.yyyy"/>
                            </h:outputText>
                        </e5ui:column>
                    </e5ui:dataTable>
                </div>
            </div>
        </div>
    </h:panelGroup>
</fieldset>
</e5ui:tabPage>

<e5ui:tabPage headerText="#{numerator.historyTabHeader}"
              actionBehavior="client" selected="#{numerator.historyTabSelected}">
    <div class="row">
        <div class="wrap" style="width: 100%; margin: 0px">
            <div class="inner">
                <e5ui:dataTable border="0" cellpadding="0" cellspacing="0"
                                id="history_list" value="#{numerator.document.historyList}"
                                var="row" grouping="false">
                    <e5ui:column style="min-width:7em">
                        <f:facet name="header">
                            <p>Дата</p>
                        </f:facet>
                        <h:outputText value="#{row.startDate}">
                            <f:convertDateTime type="date" pattern="dd.MM.yyyy HH:mm"/>
                        </h:outputText>
                    </e5ui:column>
                    <e5ui:column style="min-width:8em">
                        <f:facet name="header">
                            <p>Статус</p>
                        </f:facet>
                        <h:outputText value="#{row.fromStatusName}"/>
                    </e5ui:column>
                    <e5ui:column style="min-width:8em">
                        <f:facet name="header">
                            <p>Действие</p>
                        </f:facet>
                        <h:outputText value="#{row.actionName}"/>
                    </e5ui:column>
                    <e5ui:column style="min-width:12em">
                        <f:facet name="header">
                            <p>Автор</p>
                        </f:facet>
                        <h:outputText value="#{row.owner.descriptionShort}"/>
                    </e5ui:column>
                    <e5ui:column style="min-width:10em">
                        <f:facet name="header">
                            <p>Комментарий</p>
                        </f:facet>
                        <h:outputText value="#{row.commentary}"/>
                    </e5ui:column>
                </e5ui:dataTable>
            </div>
        </div>
    </div>
</e5ui:tabPage>
</e5ui:tabPanel>
</e5ui:formPart>
</div>

<e5ui-comp:splashScreen id="splash_screen" timeout="0">
    <f:facet name="timeoutPanel">
        <div
                style="background-color: white; border-top: solid 1px black; border-bottom: solid 1px black; padding: 30px; text-align: center; margin: 200px auto; width: 300px;">
            Пожалуйста, подождите...
        </div>
    </f:facet>
</e5ui-comp:splashScreen>
<script>
    e5ui_splashScreen.startShowOnSubmit('splash_screen',
            [ 'main_content_form' ]);
</script>
<e5ui-comp:ajaxStatusGlobal timeout="300">
    <f:facet name="waitPanel">
        <div
                style="background-color: white; border-top: solid 1px black; border-bottom: solid 1px black; padding: 30px; text-align: center; margin: 200px auto; width: 300px;">
            Пожалуйста, подождите...
        </div>
    </f:facet>
</e5ui-comp:ajaxStatusGlobal>
</ui:define>

<ui:define name="footer">

    <e5ui:multiMarker id="main_form_marker" rendered="true"
                      hintWindowStyleClass="e5ui-marker-hintWindow"
                      hintWindowInfoStyleClass="e5ui-marker-hintWindow-info"
                      hintWindowWarnStyleClass="e5ui-marker-hintWindow-warn"
                      hintWindowErrorStyleClass="e5ui-marker-hintWindow-error"
                      hintWindowFatalStyleClass="e5ui-marker-hintWindow-fatal"
                      displayMode="window">
        <h:button
                onclick="e5ui_multiMarker.remove('main_form_marker'); return false;"
                value="ОК"/>
    </e5ui:multiMarker>
    <h:outputStylesheet library="css" name="datatable.css"/>
    <h:outputStylesheet library="css" name="modalWindow.css"/>
    <h:outputStylesheet library="css" name="multiMarker.css"/>
    <h:outputStylesheet library="css" name="tabPanel.css"/>
</ui:define>

</ui:composition>

</html>