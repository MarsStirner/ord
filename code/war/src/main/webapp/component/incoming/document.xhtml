<?xml version='1.0' encoding='UTF-8' ?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml"
      xmlns:ui="http://java.sun.com/jsf/facelets"
      xmlns:h="http://java.sun.com/jsf/html"
      xmlns:f="http://java.sun.com/jsf/core"
      xmlns:p="http://primefaces.org/ui"
      xmlns:my="http://xmlns.jcp.org/jsf/composite/mycomponents"
      xmlns:c="http://java.sun.com/jsp/jstl/core"
>

<ui:composition template="/jsf-template/documentPageTemplate.xhtml">
    <f:metadata>
        <f:viewParam name="docId" value="#{viewScope['id']}"/>
        <f:viewParam name="docAction" value="#{viewScope['action']}"/>
        <f:viewAction action="#{in_doc.init(viewScope['action'], viewScope['id'])}"/>
    </f:metadata>

    <ui:define name="VARIABLE_DEFINITIONS">
        <!-- Статусы документа -->
        <c:set var="stateEditable" value="#{in_doc.createState or in_doc.editState}" scope="view"/>
        <c:set var="statusId" value="#{in_doc.document.documentStatus.id}" scope="view"/>
        <c:set var="status_OnRegistration" value="#{statusId eq 1}" scope="view"/>
        <c:set var="status_Registered" value="#{statusId eq 2}" scope="view"/>
        <c:set var="status_OnExecution" value="#{statusId eq 80}" scope="view"/>
        <c:set var="status_Executed" value="#{statusId eq 90}" scope="view"/>
        <c:set var="status_InArchive" value="#{statusId eq 100}" scope="view"/>
        <c:set var="status_OutArchive" value="#{statusId eq 110}" scope="view"/>
        <!-- Редактируемость полей (true - редактируемо, иначе только для просмотра) -->
        <c:set var="editable_ShortDescription" scope="view"
               value="#{stateEditable and editableMatrix.incoming.isFieldEditable(statusId, 'shortDescription')}"/>
        <!-- Поле 'Вид документа' -->
        <c:set var="editable_DocumentForm" scope="view"
               value="#{stateEditable and editableMatrix.incoming.isFieldEditable(statusId, 'form')}"/>
        <!-- Поле 'Тип доставки' -->
        <c:set var="editable_DeliveryType" scope="view"
               value="#{stateEditable and editableMatrix.incoming.isFieldEditable(statusId, 'deliveryType')}"/>
        <!-- Поле 'Дата исполнения' -->
        <c:set var="editable_ExecutionDate" scope="view"
               value="#{stateEditable and editableMatrix.incoming.isFieldEditable(statusId, 'executionDate')}"/>
        <!-- Поле 'Номер поступившего' -->
        <c:set var="editable_ReceivedDocumentNumber" scope="view"
               value="#{stateEditable and editableMatrix.incoming.isFieldEditable(statusId, 'receivedNumber')}"/>
        <!-- Поле 'Дата поступившего' -->
        <c:set var="editable_ReceivedDocumentDate" scope="view"
               value="#{stateEditable and editableMatrix.incoming.isFieldEditable(statusId, 'receivedDate')}"/>
        <!-- Поле 'Руководитель' -->
        <c:set var="editable_Controller" scope="view"
               value="#{stateEditable and editableMatrix.incoming.isFieldEditable(statusId, 'controller')}"/>
        <!-- Поле 'Корреспондент' -->
        <c:set var="editable_Contragent" scope="view"
               value="#{stateEditable and editableMatrix.incoming.isFieldEditable(statusId, 'contragent')}"/>
        <!-- Поле 'Адресаты'  -->
        <c:set var="editable_Recipients" scope="view"
               value="#{stateEditable and editableMatrix.incoming.isFieldEditable(statusId, 'recipients')}"/>
        <!-- Поле 'Исполнители' -->
        <c:set var="editable_Executors" scope="view"
               value="#{stateEditable and editableMatrix.incoming.isFieldEditable(statusId, 'executors')}"/>
        <!-- Конец блока переменных -->
    </ui:define>

    <ui:define name="TOOLBAR_LEFT_GROUP_CONTENT">
        <p:button icon="ui-icon-home" outcome="/component/incoming/list.xhtml"/>
        <h:outputText value="Ошибка" rendered="#{in_doc.errorState}"/>
        <p:commandButton value="Редактировать" action="#{in_doc.edit}" icon="ui-icon-pencil" update="@form"
                         rendered="#{in_doc.viewState and in_doc.editPermission and editableMatrix.incoming.isStateEditable(statusId)}"/>
        <p:commandButton value="Отменить" action="#{in_doc.view}" rendered="#{in_doc.editState}" icon="ui-icon-cancel" update="@form"/>
        <p:commandButton value="Сохранить" action="#{in_doc.save}" rendered="#{stateEditable}" icon="ui-icon-disk" update="@form"/>
        <p:commandButton value="Удалить" action="#{in_doc.delete}" rendered="#{in_doc.editState}" icon="ui-icon-trash" update="@form"/>
        <my:actionWorkflow rendered="#{in_doc.viewState and in_doc.executePermission}" model="#{in_doc.document}" workflow="#{incomingWorkflow}"/>
    </ui:define>

    <ui:define name="DOCUMENT_HEADER">
        <p:messages id="errorMessages" for="error" rendered="#{in_doc.errorState}"/>
        <h:panelGroup layout="block" id="documentHeaderDiv" rendered="#{not in_doc.errorState}" style="font-weight: bold; display:inline-block; width:85%;">
            Входящий документ
            <h:outputText value="#{in_doc.document.form.value}"/>
            <h:outputText value=" № #{in_doc.document.registrationNumber} от " rendered="#{in_doc.editState or in_doc.viewState}"/>
            <h:outputText value="#{in_doc.document.registrationDate}" rendered="#{in_doc.editState or in_doc.viewState}">
                <f:converter converterId="LocalDateTimeConverter"/>
                <f:attribute name="pattern" value="dd.MM.yyyy"/>
            </h:outputText>
            <div style="float: right; padding-right:1.5em;">
                <h:outputText id="v_author" value="Зарегистрировал: #{in_doc.document.author.description}" styleClass="outputText"/>
            </div>
        </h:panelGroup>
        <h:panelGroup layout="block" id="documentStatusDiv" rendered="#{not in_doc.errorState}"
                      style="display: inline-block; text-align: right; padding: 0.4em; background-color: rgb(60,141,188); border-radius: 4px; color: white;">
            <h:outputText value="#{in_doc.document.getDocumentStatus().getName()}"/>
        </h:panelGroup>
    </ui:define>


    <ui:define name="DOCUMENT_CONTENT">
        <p:tabView id="documentTabPanel" widgetVar="tabViewVar" rendered="#{not in_doc.errorState}" cache="false">
            <p:ajax event="tabChange" listener="#{in_doc.onTabChange}" update="documentTabPanel"/>
            <p:tab id="tab_info" title="Реквизиты">
                <p:panelGrid style="width:100%">
                    <p:row styleClass="ui-grid-row">
                        <p:column styleClass="ui-grid-col-2">
                            <p:outputLabel for="e_documentForm" value="Вид документа:"/>
                        </p:column>
                        <p:column colspan="3" styleClass="ui-grid-col-10">
                            <h:outputText id="v_documentForm" value="#{in_doc.document.form.value}" styleClass="outputText"
                                          rendered="#{not editable_DocumentForm}"/>
                            <p:selectOneMenu id="e_documentForm" value="#{in_doc.document.form}" converter="#{IncomingDocumentFormConverter}"
                                             required="true" styleClass="inputText" rendered="#{editable_DocumentForm}">
                                <f:selectItems value="#{refBookHelper.getDocumentFormsByCategory('INCOMING')}"/>
                            </p:selectOneMenu>
                        </p:column>
                    </p:row>
                    <p:row styleClass="ui-grid-row">
                        <p:column styleClass="ui-grid-col-2">
                            <p:outputLabel for="e_deliveryType" value="Тип доставки:"/>
                        </p:column>
                        <p:column colspan="3" styleClass="ui-grid-col-10">
                            <h:outputText id="v_deliveryType" value="#{in_doc.document.deliveryType.value}" styleClass="outputText"
                                          rendered="#{not editable_DeliveryType}"/>
                            <p:selectOneMenu id="e_deliveryType" value="#{in_doc.document.deliveryType}" converter="#{DeliveryTypeConverter}"
                                             styleClass="inputText" required="true" rendered="#{editable_DeliveryType}">
                                <f:selectItems value="#{refBookHelper.getDeliveryTypes()}"/>
                            </p:selectOneMenu>
                        </p:column>
                    </p:row>
                    <p:row styleClass="ui-grid-row">
                        <p:column styleClass="ui-grid-col-2">
                            <p:outputLabel for="v_registrationDate" value="Дата регистрации:"/>
                        </p:column>
                        <p:column styleClass="ui-grid-col-4">
                            <h:outputText id="v_registrationDate" value="#{in_doc.document.registrationDate}" lang="ru" styleClass="outputText">
                                <f:converter converterId="LocalDateTimeConverter"/>
                                <f:attribute name="pattern" value="dd.MM.yyyy"/>
                            </h:outputText>
                        </p:column>
                        <p:column styleClass="ui-grid-col-2">
                            <p:outputLabel for="e_executionDate" value="Срок исполнения:"/>
                        </p:column>
                        <p:column styleClass="ui-grid-col-4">
                            <h:outputText id="v_executionDate" value="#{in_doc.document.executionDate}" lang="ru" styleClass="outputText"
                                          rendered="#{not editable_ExecutionDate}">
                                <f:converter converterId="LocalDateTimeConverter"/>
                                <f:attribute name="pattern" value="dd.MM.yyyy"/>
                            </h:outputText>
                            <p:calendar id="e_executionDate" value="#{in_doc.document.executionDate}" lang="ru" locale="ru"
                                        pattern="dd.MM.yyyy" showOn="both" styleClass="inputText" rendered="#{editable_ExecutionDate}">
                                <f:converter converterId="LocalDateTimeConverter"/>
                            </p:calendar>
                        </p:column>
                    </p:row>
                    <p:row styleClass="ui-grid-row">
                        <p:column styleClass="ui-grid-col-2">
                            <p:outputLabel for="e_receivedDocumentNumber" value="Номер поступившего:"/>
                        </p:column>
                        <p:column styleClass="ui-grid-col-4">
                            <h:outputText id="v_receivedDocumentNumber" value="#{in_doc.document.receivedDocumentNumber}" styleClass="outputText"
                                          rendered="#{not editable_ReceivedDocumentNumber}"/>
                            <p:inputText id="e_receivedDocumentNumber" value="#{in_doc.document.receivedDocumentNumber}" styleClass="inputText"
                                         rendered="#{editable_ReceivedDocumentNumber}"/>
                        </p:column>
                        <p:column styleClass="ui-grid-col-2">
                            <p:outputLabel for="e_receivedDocumentDate" value="Дата поступившего:"/>
                        </p:column>
                        <p:column styleClass="ui-grid-col-4">
                            <h:outputText id="v_receivedDocumentDate" value="#{in_doc.document.receivedDocumentDate}" lang="ru"
                                          styleClass="outputText" rendered="#{not editable_ReceivedDocumentDate}">
                                <f:converter converterId="LocalDateTimeConverter"/>
                                <f:attribute name="pattern" value="dd.MM.yyyy"/>
                            </h:outputText>
                            <p:calendar id="e_receivedDocumentDate" value="#{in_doc.document.receivedDocumentDate}" lang="ru" locale="ru"
                                        pattern="dd.MM.yyyy" showOn="both" styleClass="inputText" rendered="#{editable_ReceivedDocumentDate}">
                                <f:converter converterId="LocalDateTimeConverter"/>
                            </p:calendar>
                        </p:column>
                    </p:row>
                    <p:row styleClass="ui-grid-row">
                        <p:column styleClass="ui-grid-col-2">
                            <p:outputLabel for="v_controller" value="Руководитель:" rendered="#{not editable_Controller}"/>
                            <p:commandButton value="Руководитель" actionListener="#{in_doc.chooseController}" rendered="#{editable_Controller}"
                                             styleClass="dialogButton">
                                <p:ajax event="dialogReturn" listener="#{in_doc.onControllerChosen}"
                                        update="v_controller"/>
                            </p:commandButton>
                        </p:column>
                        <p:column colspan="3" styleClass="ui-grid-col-10">
                            <h:outputText id="v_controller" value="#{in_doc.document.controller.description}" styleClass="outputText"/>
                        </p:column>
                    </p:row>
                    <p:row styleClass="ui-grid-row">
                        <p:column styleClass="ui-grid-col-2">
                            <p:outputLabel for="v_contragent" value="Корреспондент:" rendered="#{not editable_Contragent}"/>
                            <p:commandButton value="Корреспондент" actionListener="#{in_doc.chooseContragent}" rendered="#{editable_Contragent}"
                                             styleClass="dialogButton">
                                <p:ajax event="dialogReturn" listener="#{in_doc.onContragentChosen}" update="v_contragent"/>
                            </p:commandButton>
                        </p:column>
                        <p:column styleClass="ui-grid-col-10" colspan="3">
                            <h:outputText id="v_contragent" value="#{in_doc.document.contragent.value}" styleClass="outputText"/>
                        </p:column>
                    </p:row>
                    <p:row styleClass="ui-grid-row">
                        <p:column styleClass="ui-grid-col-2">
                            <p:outputLabel for="v_recipientUsers" value="Адресаты-пользователи:" rendered="#{not editable_Recipients}"/>
                            <p:commandButton value="Адресаты-пользователи" actionListener="#{in_doc.chooseRecipients}"
                                             rendered="#{editable_Recipients}" styleClass="dialogButton">
                                <p:ajax event="dialogReturn" listener="#{in_doc.onRecipientsChosen}"
                                        update="v_recipientUsers"/>
                            </p:commandButton>
                        </p:column>
                        <p:column styleClass="ui-grid-col-10" colspan="3">
                            <h:panelGroup id="v_recipientUsers">
                                <ui:repeat value="#{in_doc.document.recipientUserList}" var="recipientUser">
                                    <h:outputText value="#{recipientUser.description}" styleClass="outputText"/><br/>
                                </ui:repeat>
                            </h:panelGroup>
                        </p:column>
                    </p:row>
                    <p:row styleClass="ui-grid-row">
                        <p:column styleClass="ui-grid-col-2">
                            <p:outputLabel for="v_recipientGroups" value="Адресаты-группы:"
                                           rendered="#{not editable_Recipients}"/>
                            <p:commandButton value="Адресаты-группы" actionListener="#{in_doc.chooseRecipientGroups}" rendered="#{editable_Recipients}"
                                             styleClass="dialogButton">
                                <p:ajax event="dialogReturn" listener="#{in_doc.onRecipientGroupsChosen}" update="v_recipientGroups"/>
                            </p:commandButton>
                        </p:column>
                        <p:column styleClass="ui-grid-col-10" colspan="3">
                            <h:panelGroup id="v_recipientGroups">
                                <ui:repeat value="#{in_doc.document.recipientGroupsList}" var="recipientGroup">
                                    <h:outputText value="#{recipientGroup.value}" styleClass="outputText"/><br/>
                                </ui:repeat>
                            </h:panelGroup>
                        </p:column>
                    </p:row>
                    <p:row styleClass="ui-grid-row">
                        <p:column styleClass="ui-grid-col-2">
                            <p:outputLabel for="v_executors" value="Исполнители:" rendered="#{not editable_Executors}"/>
                            <p:commandButton value="Исполнители" actionListener="#{in_doc.chooseExecutors}" rendered="#{editable_Executors}"
                                             styleClass="dialogButton">
                                <p:ajax event="dialogReturn" listener="#{in_doc.onExecutorsChosen}" update="v_executors"/>
                            </p:commandButton>
                        </p:column>
                        <p:column styleClass="ui-grid-col-10" colspan="9">
                            <h:panelGroup id="v_executors">
                                <ui:repeat value="#{in_doc.document.executorsList}" var="executor">
                                    <h:outputText value="#{executor.description}" styleClass="outputText"/><br/>
                                </ui:repeat>
                            </h:panelGroup>
                        </p:column>
                    </p:row>
                    <p:row styleClass="ui-grid-row">
                        <p:column styleClass="ui-grid-col-2">
                            <p:outputLabel for="e_shortDescription" value="Краткое содержание:"/>
                        </p:column>
                        <p:column colspan="3" styleClass="ui-grid-col-10">
                            <h:outputText id="v_shortDescription" value="#{in_doc.document.shortDescription}" rendered="#{not editable_ShortDescription}"
                                          styleClass="outputText"/>
                            <p:inputTextarea id="e_shortDescription" value="#{in_doc.document.shortDescription}" rendered="#{editable_ShortDescription}"
                                             styleClass="inputText"/>
                        </p:column>
                    </p:row>
                </p:panelGrid>
            </p:tab>
            <p:tab id="tab_task" title="Движение документа">
                <my:taskTreeTable id="taskTable" controller="#{in_doc.taskTree}">
                    <f:facet name="additionalButtons">
                        <p:button value="Новая резолюция" id="add_resolution_btn" outcome="#{ui['document.task.page.link']}" target="_blank"
                                  icon="ui-icon-plusthick" rendered="#{status_Registered}">
                            <f:param name="docAction" value="create"/>
                            <f:param name="rootDocumentId" value="#{in_doc.document.uniqueId}"/>
                            <f:param name="formId" value="TASK_RESOLUTION"/>
                        </p:button>
                        <p:button value="Новое поручение" id="add_assigment_btn" outcome="#{ui['document.task.page.link']}" target="_blank"
                                  icon="ui-icon-plusthick" rendered="#{status_OnExecution}">
                            <f:param name="docAction" value="create"/>
                            <f:param name="rootDocumentId" value="#{in_doc.document.uniqueId}"/>
                            <f:param name="formId" value="TASK_ASSIGMENT"/>
                        </p:button>
                    </f:facet>
                </my:taskTreeTable>
            </p:tab>
            <p:tab id="tab_relation" title="Связи">
                <p:dataTable id="table_relation" value="#{in_doc.relatedDocuments}"
                             var="outgoing_document_row"
                             emptyMessage="#{ui['document.default.list.emptyMessage']}"
                             selectionMode="single"
                             resizableColumns="true"
                             widgetVar="relationDocumentTableVar"
                             rowKey="#{outgoing_document_row.id}">
                    <f:facet name="header">
                        <h:outputText value="Исходящие документы"/>
                    </f:facet>
                    <p:column headerText="Дата регистрации" style="width:9em;" styleClass="outputText">
                        <h:outputText value="#{outgoing_document_row.registrationDate}">
                            <f:converter converterId="LocalDateTimeConverter"/>
                            <f:attribute name="pattern" value="dd.MM.yyyy"/>
                        </h:outputText>
                    </p:column>
                    <p:column headerText="Номер" style="width:5em;" styleClass="outputText">
                        <h:outputText value="#{outgoing_document_row.registrationNumber}"/>
                    </p:column>
                    <p:column headerText="Исполнитель" style="width:12em;" styleClass="outputText">
                        <h:outputText value="#{outgoing_document_row.executor.getDescriptionShort()}"/>
                    </p:column>
                    <p:column headerText="Адресат" style="width:12em;" styleClass="outputText">
                        <h:outputText value="#{outgoing_document_row.contragent.value}"/>
                    </p:column>
                    <p:column headerText="Вид" style="width:7em;" styleClass="outputText">
                        <h:outputText value="#{outgoing_document_row.form.value}"/>
                    </p:column>
                    <p:column headerText="Статус" style="width:9em;" styleClass="outputText">
                        <h:outputText value="#{outgoing_document_row.getDocumentStatus().getName()}"/>
                    </p:column>
                    <p:column headerText="Краткое содержание" styleClass="outputText">
                        <h:outputText value="#{outgoing_document_row.shortDescription}"/>
                    </p:column>
                    <p:ajax event="rowSelect"
                            onstart="goToOutgoingDocument(PrimeFaces.widgets.relationDocumentTableVar.selection); return false;"/>
                </p:dataTable>
            </p:tab>
            <p:tab id="tab_access" title="Доступ">
                <my:accessManagement model="#{in_doc.document}" controller="#{in_doc}" editable="#{stateEditable}"
                                     editableEditors="#{stateEditable and editableMatrix.incoming.isFieldEditable(statusId, 'accessEditors')}"
                                     editableReaders="#{stateEditable and editableMatrix.incoming.isFieldEditable(statusId, 'accessReaders')}"/>
            </p:tab>
            <p:tab id="tab_history" title="История">
                <my:historyTable id="historyTable" value="#{in_doc.document.historyList}"/>
            </p:tab>
            <c:if test="#{not in_doc.createState}">
                <p:tab id="tab_files" title="Файлы">
                    <my:attachmentManagement id="attachmentManager"
                                             attachments="#{in_doc.attachments}"
                                             documentFolder="#{in_doc.document.uniqueId}"
                                             allowDelete="#{statusId lt 90 and in_doc.editPermission}"
                                             allowAttach="#{in_doc.editPermission}"/>
                </p:tab>
            </c:if>
        </p:tabView>
    </ui:define>

    <ui:define name="DIALOGS">
        <p:growl id="msg"/>
        <!-- Сообщения о фактах просмотра-->
        <p:growl id="viewFactMessage" for="viewFact"/>
    </ui:define>
</ui:composition>
</html>