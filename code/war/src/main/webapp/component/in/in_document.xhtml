<?xml version='1.0' encoding='UTF-8' ?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
        "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml"
      xmlns:ui="http://java.sun.com/jsf/facelets"
      xmlns:h="http://java.sun.com/jsf/html"
      xmlns:f="http://java.sun.com/jsf/core"
      xmlns:e5ui="http://efive.ru/uitemplates"
      xmlns:p="http://primefaces.org/ui"
      xmlns:my="http://xmlns.jcp.org/jsf/composite/mycomponents"
      xmlns:c="http://java.sun.com/jsp/jstl/core"
        >

<ui:composition template="/jsf-template/documentPageTemplate.xhtml">

    <ui:define name="HEAD_CONTENT">
        <h:outputScript library="js" name="primefacesLocale_ru.js"/>
        <h:outputStylesheet library="css" name="primefacesExtension/calendarIcon.css"/>
    </ui:define>

    <ui:define name="TOOLBAR_LEFT_GROUP_CONTENT">
        <my:homeButton outcome="/component/in/in_documents.xhtml"/>
        <h:outputText value="Ошибка" rendered="#{in_doc.errorState}"/>
        <p:commandButton value="Редактировать" action="#{in_doc.edit}" rendered="#{in_doc.viewState and in_doc.editPermission}"
                         icon="ui-icon-pencil" update="@form"/>
        <p:commandButton value="Отменить" action="#{in_doc.view}" rendered="#{in_doc.editState}"
                         icon="ui-icon-cancel" update="@form"/>
        <p:commandButton value="Сохранить" action="#{in_doc.save}" rendered="#{in_doc.editState or in_doc.createState}"
                         icon="ui-icon-disk" update="@form"/>
        <p:commandButton value="Удалить" action="#{in_doc.delete}" rendered="#{in_doc.editState}"
                         icon="ui-icon-trash" update="@form"/>
        <p:commandButton value="Действия" action="#{in_doc.processorModal.show}" rendered="#{in_doc.viewState and in_doc.executePermission}"
                         icon="ui-icon-circle-triangle-e" update="actionDialog" oncomplete="PF('actionDialogVar').show();"/>
    </ui:define>

    <ui:define name="DOCUMENT_HEADER">
        <!-- Статусы документа -->
        <c:set var="statusId" value="#{in_doc.document.documentStatus.id}"/>
        <c:set var="status_OnRegistration" value="#{statusId eq 1}"/>
        <c:set var="status_Registered" value="#{statusId eq 2}"/>
        <c:set var="status_OnExecution" value="#{statusId eq 80}"/>
        <c:set var="status_Executed" value="#{statusId eq 90}"/>
        <c:set var="status_InArchive" value="#{statusId eq 100}"/>
        <c:set var="status_OutArchive" value="#{statusId eq 110}"/>
        <!-- Редактируемость полей (true - редактируемо, иначе только для просмотра) -->
        <!-- Поле 'Краткое содержание' редактируется только при создании ИЛИ при редактировании в статусе 'На регистрации' -->
        <c:set var="editable_ShortDescription" value="#{in_doc.createState or (in_doc.editState and status_OnRegistration)}"/>
        <!-- Поле 'Вид документа' редактируется только при создании ИЛИ при редактировании в статусах 'На регистрации'/'Зарегистрирован'/'На исполнении' -->
        <c:set var="editable_DocumentForm"
               value="#{in_doc.createState or (in_doc.editState and (status_OnRegistration or status_Registered or status_OnExecution))}"/>
        <!-- Поле 'Тип доставки' редактируется только при создании ИЛИ при редактировании в статусе 'На регистрации' -->
        <c:set var="editable_DeliveryType" value="#{in_doc.createState or (in_doc.editState and status_OnRegistration)}"/>
        <!-- Поле 'Номер поступившего' редактируется только при создании ИЛИ при редактировании в статусе 'На регистрации' -->
        <c:set var="editable_ReceivedDocumentNumber" value="#{in_doc.createState or (in_doc.editState and status_OnRegistration)}"/>
        <!-- Поле 'Дата поступившего' редактируется только при создании ИЛИ при редактировании в статусе 'На регистрации' -->
        <c:set var="editable_ReceivedDocumentDate" value="#{in_doc.createState or (in_doc.editState and status_OnRegistration)}"/>
        <!-- Поле 'Руководитель' редактируется только при создании ИЛИ при редактировании в статусе 'На регистрации' -->
        <c:set var="editable_Controller" value="#{in_doc.createState or (in_doc.editState and status_OnRegistration)}"/>
        <!-- Поле 'Корреспондент' редактируется только при создании ИЛИ при редактировании в статусе 'На регистрации' -->
        <c:set var="editable_Contragent" value="#{in_doc.createState or (in_doc.editState and status_OnRegistration)}"/>
        <!-- Поле 'Адресаты' редактируется только при создании ИЛИ при редактировании в статусе 'На регистрации' -->
        <c:set var="editable_Recipients" value="#{in_doc.createState or (in_doc.editState and status_OnRegistration)}"/>
        <!-- Поле 'Исполнители' редактируется только при создании ИЛИ при редактировании в статусах 'На регистрации'/'Зарегистрирован'/'На исполнении' -->
        <c:set var="editable_Executors"
               value="#{in_doc.createState or (in_doc.editState and (status_OnRegistration or status_Registered or status_OnExecution))}"/>
        <!-- Поле 'Доступ-редакторы' редактируется только при создании ИЛИ при редактировании в статусах 'На регистрации'/'Зарегистрирован'/'На исполнении' -->
        <c:set var="editable_AccessTabEditors"
               value="#{in_doc.createState or (in_doc.editState and (status_OnRegistration or status_Registered or status_OnExecution))}"/>
        <!-- Конец блока переменных -->
        <p:messages id="errorMessages" for="error" rendered="#{in_doc.errorState}"/>
        <h:panelGroup layout="block" id="documentHeaderDiv" rendered="#{not in_doc.errorState}"
                      style="font-weight: bold; display:inline-block; width:85%;">
            Входящий документ
            <h:outputText value="#{in_doc.document.form.value}"/>
            <h:outputText value=" № #{in_doc.document.registrationNumber} от " rendered="#{in_doc.editState or in_doc.viewState}"/>
            <h:outputText value="#{in_doc.document.registrationDate}" rendered="#{in_doc.editState or in_doc.viewState}">
                <f:convertDateTime type="date" pattern="dd.MM.yyyy"/>
            </h:outputText>
        </h:panelGroup>
        <h:panelGroup layout="block" id="documentStatusDiv"
                      style="display: inline-block; text-align: right; padding: 0.4em;
                            background-color: rgb(60,141,188); border-radius: 4px; color: white;"
                      rendered="#{not in_doc.errorState}">
            <h:outputText value="#{in_doc.document.getDocumentStatus().getName()}"/>
        </h:panelGroup>
    </ui:define>


    <ui:define name="DOCUMENT_CONTENT">
        <p:tabView id="documentTabPanel" widgetVar="incomingDocumentTabViewVar" activeIndex="0" effect="fade" effectDuration="fast"
                   rendered="#{not in_doc.errorState}">
            <p:tab id="tab_info" title="Реквизиты">
                <p:panelGrid>
                    <p:row styleClass="ui-grid-row">
                        <p:column styleClass="ui-grid-col-2">
                            <p:outputLabel for="e_shortDescription" value="Краткое содержание:"
                                           title="Поле 'Краткое содержание' редактируется только при создании ИЛИ при редактировании в статусе 'На регистрации'"/>
                        </p:column>
                        <p:column colspan="3" styleClass="ui-grid-col-10">
                            <h:outputText id="v_shortDescription" value="#{in_doc.document.shortDescription}"
                                          rendered="#{not editable_ShortDescription}" styleClass="outputText" style="word-break: break-all"/>
                            <p:inputTextarea id="e_shortDescription" value="#{in_doc.document.shortDescription}"
                                             rendered="#{editable_ShortDescription}" styleClass="inputText" style="width:100%;"/>
                        </p:column>
                    </p:row>
                    <p:row styleClass="ui-grid-row">
                        <p:column styleClass="ui-grid-col-2">
                            <p:outputLabel for="e_documentForm" value="Вид документа:"
                                           title="Поле 'Вид документа' редактируется только при создании ИЛИ при редактировании в статусах 'На регистрации'/'Зарегистрирован'/'На исполнении'"/>
                        </p:column>
                        <p:column colspan="3" styleClass="ui-grid-col-10">
                            <h:outputText id="v_documentForm" value="#{in_doc.document.form.value}" styleClass="outputText"
                                          rendered="#{not editable_DocumentForm}"/>
                            <p:selectOneMenu id="e_documentForm" value="#{in_doc.document.form}" converter="IncomingDocumentFormConverter"
                                             required="true" styleClass="inputText" style="width:100%;" rendered="#{editable_DocumentForm}">
                                <f:selectItems value="#{dictionaryManagement.getDocumentFormsByCategory('INCOMING')}"/>
                            </p:selectOneMenu>
                        </p:column>
                    </p:row>
                    <p:row styleClass="ui-grid-row">
                        <p:column styleClass="ui-grid-col-2">
                            <p:outputLabel for="e_deliveryType" value="Тип доставки:"
                                           title="Поле 'Тип доставки' редактируется только при создании ИЛИ при редактировании в статусе 'На регистрации'"/>
                        </p:column>
                        <p:column colspan="3" styleClass="ui-grid-col-10">
                            <h:outputText id="v_deliveryType" value="#{in_doc.document.deliveryType.value}" styleClass="outputText"
                                          rendered="#{not editable_DeliveryType}"/>
                            <p:selectOneMenu id="e_deliveryType" value="#{in_doc.document.deliveryType}" converter="#{DeliveryTypeConverter}"
                                             styleClass="inputText" style="width:100%;" required="true" rendered="#{editable_DeliveryType}">
                                <f:selectItems value="#{dictionaryManagement.getDeliveryTypes()}"/>
                            </p:selectOneMenu>
                        </p:column>
                    </p:row>
                    <p:row styleClass="ui-grid-row">
                        <p:column styleClass="ui-grid-col-2">
                            <p:outputLabel for="v_registrationDate" value="Дата регистрации:"
                                           title="Не редактируется ни при каких условиях, изменить значение можно только с помощью 'Действий'"/>
                        </p:column>
                        <p:column styleClass="ui-grid-col-4">
                            <h:outputText id="v_registrationDate" value="#{in_doc.document.registrationDate}" lang="ru" styleClass="outputText">
                                <f:convertDateTime type="date" pattern="dd.MM.yyyy"/>
                            </h:outputText>
                        </p:column>
                        <p:column styleClass="ui-grid-col-3">
                            <p:outputLabel for="v_executionDate" value="Дата исполнения:"
                                           title="Не редактируется ни при каких условиях, изменить значение можно только с помощью 'Действий'"/>
                        </p:column>
                        <p:column styleClass="ui-grid-col-3">
                            <h:outputText id="v_executionDate" value="#{in_doc.document.executionDate}" lang="ru" styleClass="outputText">
                                <f:convertDateTime type="date" pattern="dd.MM.yyyy"/>
                            </h:outputText>
                        </p:column>
                    </p:row>
                    <p:row styleClass="ui-grid-row">
                        <p:column styleClass="ui-grid-col-2">
                            <p:outputLabel for="e_receivedDocumentNumber" value="Номер поступившего:"
                                           title="Поле 'Номер поступившего' редактируется только при создании ИЛИ при редактировании в статусе 'На регистрации'"/>
                        </p:column>
                        <p:column styleClass="ui-grid-col-4">
                            <h:outputText id="v_receivedDocumentNumber" value="#{in_doc.document.receivedDocumentNumber}" styleClass="outputText"
                                          rendered="#{not editable_ReceivedDocumentNumber}"/>
                            <p:inputText id="e_receivedDocumentNumber" value="#{in_doc.document.receivedDocumentNumber}" styleClass="inputText"
                                         rendered="#{editable_ReceivedDocumentNumber}"/>
                        </p:column>
                        <p:column styleClass="ui-grid-col-3">
                            <p:outputLabel for="e_receivedDocumentDate" value="Дата поступившего:"
                                           title="Поле 'Дата поступившего' редактируется только при создании ИЛИ при редактировании в статусе 'На регистрации'"/>
                        </p:column>
                        <p:column styleClass="ui-grid-col-3">
                            <h:outputText id="v_receivedDocumentDate" value="#{in_doc.document.receivedDocumentDate}" lang="ru"
                                          styleClass="outputText" rendered="#{not editable_ReceivedDocumentDate}">
                                <f:convertDateTime type="date" pattern="dd.MM.yyyy"/>
                            </h:outputText>
                            <p:calendar id="e_receivedDocumentDate" value="#{in_doc.document.receivedDocumentDate}" lang="ru" locale="ru"
                                        pattern="dd.MM.yyyy" showOn="both" styleClass="inputText"
                                        rendered="#{editable_ReceivedDocumentDate}"/>
                        </p:column>
                    </p:row>
                    <p:row styleClass="ui-grid-row">
                        <p:column styleClass="ui-grid-col-2">
                            <p:outputLabel for="v_author" value="Автор:"
                                           title="Поле 'Автор' не редактируемо и заполняется автоматически тем пользователем, который создал документ"/>
                        </p:column>
                        <p:column styleClass="ui-grid-col-4">
                            <h:outputText id="v_author" value="#{in_doc.document.author.description}" styleClass="outputText"/>
                        </p:column>
                        <p:column styleClass="ui-grid-col-3">
                            <p:outputLabel for="v_controller" value="Руководитель:"/>
                            <p:commandButton icon="ui-icon-pencil" actionListener="#{in_doc.chooseController}" rendered="#{editable_Controller}">
                                <p:ajax event="dialogReturn" listener="#{in_doc.onControllerChosen}" update="v_controller"/>
                            </p:commandButton>
                        </p:column>
                        <p:column styleClass="ui-grid-col-3">
                            <h:outputText id="v_controller" value="#{in_doc.document.controller.description}" styleClass="outputText"/>
                        </p:column>
                    </p:row>
                    <p:row styleClass="ui-grid-row">
                        <p:column styleClass="ui-grid-col-2">
                            <p:outputLabel for="v_contragent" value="Корреспондент:"/>
                            <p:commandButton icon="ui-icon-pencil" actionListener="#{in_doc.chooseContragent}" rendered="#{editable_Contragent}">
                                <p:ajax event="dialogReturn" listener="#{in_doc.onContragentChosen}" update="v_contragent"/>
                            </p:commandButton>
                        </p:column>
                        <p:column styleClass="ui-grid-col-10" colspan="3">
                            <h:outputText id="v_contragent" value="#{in_doc.document.contragent.value}" styleClass="outputText"/>
                        </p:column>
                    </p:row>
                    <p:row styleClass="ui-grid-row">
                        <p:column styleClass="ui-grid-col-2">
                            <p:outputLabel for="v_recipientUsers" value="Адресаты-пользователи: *"/>
                            <p:commandButton icon="ui-icon-pencil" actionListener="#{in_doc.chooseRecipients}" rendered="#{editable_Recipients}">
                                <p:ajax event="dialogReturn" listener="#{in_doc.onRecipientsChosen}" update="v_recipientUsers"/>
                            </p:commandButton>
                        </p:column>
                        <p:column styleClass="ui-grid-col-10" colspan="3">
                            <h:panelGroup id="v_recipientUsers">
                                <ui:repeat value="#{in_doc.document.recipientUserList}" var="recipientUser">
                                    <h:outputText value="#{recipientUser.description}" styleClass="outputText"/><br/>
                                </ui:repeat>
                            </h:panelGroup>
                        </p:column>
                    </p:row>
                    <p:row styleClass="ui-grid-row">
                        <p:column styleClass="ui-grid-col-2">
                            <p:outputLabel for="v_recipientGroups" value="Адресаты-группы:"/>
                            <p:commandButton icon="ui-icon-pencil" actionListener="#{in_doc.chooseRecipientGroups}" rendered="#{editable_Recipients}">
                                <p:ajax event="dialogReturn" listener="#{in_doc.onRecipientGroupsChosen}" update="v_recipientGroups"/>
                            </p:commandButton>
                        </p:column>
                        <p:column styleClass="ui-grid-col-10" colspan="3">
                            <h:panelGroup id="v_recipientGroups">
                                <ui:repeat value="#{in_doc.document.recipientGroupsList}" var="recipientGroup">
                                    <h:outputText value="#{recipientGroup.value}" styleClass="outputText"/><br/>
                                </ui:repeat>
                            </h:panelGroup>
                        </p:column>
                    </p:row>
                    <p:row styleClass="ui-grid-row">
                        <p:column styleClass="ui-grid-col-2">
                            <p:outputLabel for="v_executors" value="Исполнители:"/>
                            <p:commandButton icon="ui-icon-pencil" actionListener="#{in_doc.chooseExecutors}" rendered="#{editable_Executors}">
                                <p:ajax event="dialogReturn" listener="#{in_doc.onExecutorsChosen}" update="v_executors"/>
                            </p:commandButton>
                        </p:column>
                        <p:column styleClass="ui-grid-col-10" colspan="3">
                            <h:panelGroup id="v_executors">
                                <ui:repeat value="#{in_doc.document.executorsList}" var="executor">
                                    <h:outputText value="#{executor.description}" styleClass="outputText"/><br/>
                                </ui:repeat>
                            </h:panelGroup>
                        </p:column>
                    </p:row>
                </p:panelGrid>
            </p:tab>
            <p:tab id="tab_task" title="Поручения">
                <p:treeTable id="task_table"
                             value="#{in_doc.taskTreeHolder.root}"
                             var="row_task"
                             selectionMode="single"
                             emptyMessage="Записей нет"
                             widgetVar="taskTableVar">
                    <p:column headerText="Дата создания" style="width:4.5em;" styleClass="outputText">
                        <h:outputText value="#{row_task.creationDate}">
                            <f:convertDateTime type="date" pattern="dd.MM.yyyy"/>
                        </h:outputText>
                    </p:column>
                    <p:column headerText="Номер" style="width:6em;" styleClass="outputText">
                        <h:outputText value="#{row_task.taskNumber}"/>
                    </p:column>
                    <p:column headerText="Автор" style="width:9em; white-space: normal;" styleClass="outputText">
                        <h:outputText value="#{row_task.author.getDescription()}"/>
                    </p:column>
                    <p:column headerText="Исполнитель" style="width:9em; white-space: normal;" styleClass="outputText">
                        <ui:repeat value="#{row_task.executorsList}" var="executor">
                            <h:outputText value="#{executor.description}"/><br/>
                        </ui:repeat>
                    </p:column>
                    <p:column headerText="Срок исполнения" style="width:4.5em;" styleClass="outputText">
                        <h:outputText value="#{row_task.controlDate}">
                            <f:convertDateTime type="date" pattern="dd.MM.yyyy"/>
                        </h:outputText>
                    </p:column>
                    <p:column headerText="Содержание" style="white-space: normal;" styleClass="outputText">
                        <h:outputText value="#{row_task.shortDescription}"/>
                    </p:column>
                    <p:column headerText="Статус" style="width:5em;" styleClass="outputText">
                        <h:outputText value="#{row_task.getDocumentStatus().getName()}"/>
                    </p:column>
                    <p:column style="display:none;">
                        <input type="hidden" value="#{row_task.id}"/>
                    </p:column>
                    <p:ajax event="expand" oncomplete="addRowHandlers()"/>
                </p:treeTable>
                <script type="text/javascript">
                    $(window).load(function () {
                        PrimeFaces.widgets.taskTableVar._render = function () {
                            if (this.cfg.scrollable) {
                                this.setupScrolling()
                            }
                            if (this.cfg.resizableColumns) {
                                this.setupResizableColumns()
                            }
                            this.bindEvents();
                            addRowHandlers();
                        }
                    });
                </script>
                <p:toolbar id="taskToolBar">
                    <p:toolbarGroup>
                        <p:button value="Новая резолюция" id="task_add_resolution_btn" outcome="/component/task/task.xhtml" target="_blank"
                                  icon="ui-icon-plusthick" rendered="#{status_Registered}">
                            <f:param name="docAction" value="create"/>
                            <f:param name="rootDocumentId" value="#{in_doc.document.uniqueId}"/>
                            <f:param name="formId" value="TASK_RESOLUTION"/>
                        </p:button>
                        <p:button value="Новое поручение" id="task_add_assigment_btn" outcome="/component/task/task.xhtml" target="_blank"
                                  icon="ui-icon-plusthick" rendered="#{status_OnExecution}">
                            <f:param name="docAction" value="create"/>
                            <f:param name="rootDocumentId" value="#{in_doc.document.uniqueId}"/>
                            <f:param name="formId" value="TASK_ASSIGMENT"/>
                        </p:button>
                        <p:commandButton value="Обновить" id="task_refresh_btn" action="#{in_doc.taskTreeHolder.refresh}"
                                         update="task_table" icon="ui-icon-refresh"/>
                        <p:commandButton value="Свернуть все" id="task_collapse_btn" action="#{in_doc.taskTreeHolder.collapseAll}"
                                         update="task_table" icon="ui-icon-carat-1-w"/>
                        <p:commandButton value="Развернуть все" id="task_expand_btn" action="#{in_doc.taskTreeHolder.expandAll}"
                                         update="task_table" icon="ui-icon-carat-1-e"/>
                    </p:toolbarGroup>
                </p:toolbar>
            </p:tab>
            <p:tab id="tab_relation" title="Связи">
                <p:dataTable id="table_relation" value="#{in_doc.getRelatedDocuments()}"
                             var="outgoing_document_row"
                             emptyMessage="#{props['EMPTY_RESULT']}"
                             selectionMode="single"
                             widgetVar="relationDocumentTableVar"
                             rowKey="#{outgoing_document_row.id}">
                    <f:facet name="header">
                        <h:outputText value="Исходящие документы"/>
                    </f:facet>
                    <p:column headerText="Дата регистрации" style="width:9em;" styleClass="outputText">
                        <h:outputText value="#{outgoing_document_row.registrationDate}">
                            <f:convertDateTime type="date" pattern="dd.MM.yyyy"/>
                        </h:outputText>
                    </p:column>
                    <p:column headerText="Номер" style="width:5em;" styleClass="outputText">
                        <h:outputText value="#{outgoing_document_row.registrationNumber}"/>
                    </p:column>
                    <p:column headerText="Исполнитель" style="width:12em;" styleClass="outputText">
                        <h:outputText value="#{outgoing_document_row.executor.getDescriptionShort()}"/>
                    </p:column>
                    <p:column headerText="Адресат" style="width:12em;" styleClass="outputText">
                        <h:outputText value="#{outgoing_document_row.contragent.value}"/>
                    </p:column>
                    <p:column headerText="Вид" style="width:7em;" styleClass="outputText">
                        <h:outputText value="#{outgoing_document_row.form.value}"/>
                    </p:column>
                    <p:column headerText="Статус" style="width:9em;" styleClass="outputText">
                        <h:outputText value="#{outgoing_document_row.getDocumentStatus().getName()}"/>
                    </p:column>
                    <p:column headerText="Краткое содержание" styleClass="outputText">
                        <h:outputText value="#{outgoing_document_row.shortDescription}"/>
                    </p:column>
                    <p:ajax event="rowSelect" onstart="goToOutgoingDocument(PrimeFaces.widgets.relationDocumentTableVar.selection); return false;"/>
                </p:dataTable>
            </p:tab>
            <p:tab id="tab_access" title="Доступ">
                <p:panelGrid style="width:100%">
                    <p:row styleClass="ui-grid-row">
                        <p:column styleClass="ui-grid-col-4">
                            <p:outputLabel for="e_docAccessLevel" value="Уровень допуска:"/>
                        </p:column>
                        <p:column styleClass="ui-grid-col-8">
                            <h:outputText id="v_docAccessLevel" value="#{in_doc.document.userAccessLevel.value}" rendered="#{in_doc.viewState}"
                                          styleClass="outputText"/>
                            <p:selectOneMenu id="e_docAccessLevel" value="#{in_doc.document.userAccessLevel}"
                                             converter="UserAccessLevelConverter" rendered="#{in_doc.editState or in_doc.createState}">
                                <f:selectItems var="level"
                                               value="#{dictionaryManagement.getUserAccessLevelsGreaterOrEqualMaxValue(sessionManagement.authData.currentAccessLevel.level)}"
                                               itemLabel="#{level.value}"/>
                            </p:selectOneMenu>
                        </p:column>
                    </p:row>
                    <p:row styleClass="ui-grid-row">
                        <p:column styleClass="ui-grid-col-4">
                            <p:outputLabel for="v_person_readers" value="Пользователи-читатели:"/>
                            <p:commandButton icon="ui-icon-pencil" actionListener="#{in_doc.choosePersonReaders}"
                                             rendered="#{in_doc.createState or in_doc.editState}">
                                <p:ajax event="dialogReturn" listener="#{in_doc.onPersonReadersChosen}" update="v_person_readers"/>
                            </p:commandButton>
                        </p:column>
                        <p:column styleClass="ui-grid-col-8">
                            <h:panelGroup id="v_person_readers">
                                <ui:repeat value="#{in_doc.document.personReadersList}" var="personReader">
                                    <h:outputText value="#{personReader.description}" styleClass="outputText"/><br/>
                                </ui:repeat>
                            </h:panelGroup>
                        </p:column>
                    </p:row>
                    <p:row styleClass="ui-grid-row">
                        <p:column styleClass="ui-grid-col-4">
                            <p:outputLabel for="v_person_editors" value="Пользователи-редакторы:"/>
                            <p:commandButton icon="ui-icon-pencil" actionListener="#{in_doc.choosePersonEditors}" rendered="#{editable_AccessTabEditors}">
                                <p:ajax event="dialogReturn" listener="#{in_doc.onPersonEditorsChosen}" update="v_person_editors"/>
                            </p:commandButton>
                        </p:column>
                        <p:column styleClass="ui-grid-col-8">
                            <h:panelGroup id="v_person_editors">
                                <ui:repeat value="#{in_doc.document.personEditorsList}" var="personEditor">
                                    <h:outputText value="#{personEditor.description}" styleClass="outputText"/><br/>
                                </ui:repeat>
                            </h:panelGroup>
                        </p:column>
                    </p:row>
                    <p:row styleClass="ui-grid-row">
                        <p:column styleClass="ui-grid-col-4">
                            <p:outputLabel for="v_role_readers" value="Роли-читатели:"/>
                            <p:commandButton icon="ui-icon-pencil" actionListener="#{in_doc.chooseRoleReaders}"
                                             rendered="#{in_doc.createState or in_doc.editState}">
                                <p:ajax event="dialogReturn" listener="#{in_doc.onRoleReadersChosen}" update="v_role_readers"/>
                            </p:commandButton>
                        </p:column>
                        <p:column styleClass="ui-grid-col-8">
                            <h:panelGroup id="v_role_readers">
                                <ui:repeat value="#{in_doc.document.roleReadersList}" var="roleReader">
                                    <h:outputText value="#{roleReader.name}" styleClass="outputText"/><br/>
                                </ui:repeat>
                            </h:panelGroup>
                        </p:column>
                    </p:row>
                    <p:row styleClass="ui-grid-row">
                        <p:column styleClass="ui-grid-col-4">
                            <p:outputLabel for="v_role_editors" value="Роли-редакторы:"/>
                            <p:commandButton icon="ui-icon-pencil" actionListener="#{in_doc.chooseRoleEditors}"
                                             rendered="#{editable_AccessTabEditors}">
                                <p:ajax event="dialogReturn" listener="#{in_doc.onRoleEditorsChosen}" update="v_role_editors"/>
                            </p:commandButton>
                        </p:column>
                        <p:column styleClass="ui-grid-col-8">
                            <h:panelGroup id="v_role_editors">
                                <ui:repeat value="#{in_doc.document.roleEditorsList}" var="roleEditor">
                                    <h:outputText value="#{roleEditor.name}" styleClass="outputText"/><br/>
                                </ui:repeat>
                            </h:panelGroup>
                        </p:column>
                    </p:row>
                </p:panelGrid>
            </p:tab>
            <p:tab id="tab_history" title="История">
                <my:historyTable id="historyTable" value="#{in_doc.document.historyList}"/>
            </p:tab>
            <p:tab id="tab_files" title="Файлы" rendered="#{not in_doc.createState}">
                <p:dataTable id="table_attachment" value="#{in_doc.attachments}" var="attachment" rowExpandMode="single">
                    <p:column style="width:1em" styleClass="outputText">
                        <p:rowToggler rendered="#{not empty attachment.revisions}"/>
                    </p:column>
                    <p:column headerText="Имя файла" styleClass="outputText">
                        <h:outputText
                                value="#{not empty attachment.currentRevision.fileName ? attachment.currentRevision.fileName : attachment.fileName}"/>
                    </p:column>
                    <p:column headerText="Версия" style="width:10em" styleClass="outputText">
                        <h:outputText value="#{attachment.currentRevision.version}" style="padding-right:0.5em;"/>
                        <p:commandButton value="Добавить" icon="ui-icon-extlink" actionListener="#{in_doc.addVersionForAttachment(attachment)}">
                            <p:ajax event="dialogReturn" listener="#{in_doc.handleAddVersionDialogResult}" update=":documentForm:msg"/>
                        </p:commandButton>
                    </p:column>
                    <p:column headerText="Пользователь" style="width:12em" styleClass="outputText">
                        <h:outputText
                                value="#{userList.getUserFullNameById(attachment.currentRevision.authorId != 0 ? attachment.currentRevision.authorId : attachment.authorId)}"/>
                    </p:column>
                    <p:column headerText="Скачать" style="width:7em">
                        <p:commandButton value="Скачать" ajax="false" onclick="PrimeFaces.monitorDownload(showStatus, hideStatus)">
                            <p:fileDownload value="#{fileManagement.download(attachment.id)}"/>
                        </p:commandButton>
                    </p:column>
                    <p:column headerText="Удалить" rendered="#{statusId lt 90}" style="width:7em">
                        <p:commandButton value="Удалить" action="#{in_doc.deleteAttachment(attachment)}"/>
                    </p:column>
                    <p:rowExpansion styleClass="no-padding">
                        <p:dataTable var="revision" value="#{attachment.revisions}" styleClass="hide-column-names"
                                     style="padding-left: 2.1em; padding-right:0;">
                            <f:facet name="header">
                                История версий для файла #{not empty attachment.currentRevision.fileName ? attachment.currentRevision.fileName : attachment.fileName}
                            </f:facet>
                            <p:column headerText="Имя файла" styleClass="outputText">
                                <h:outputText value="#{not empty revision.fileName ? revision.fileName : attachment.fileName}"/>
                            </p:column>
                            <p:column headerText="Версия" style="width:4em" styleClass="outputText">
                                <h:outputText value="#{revision.version}"/>
                            </p:column>
                            <p:column headerText="Пользователь" style="width:12em" styleClass="outputText">
                                <h:outputText
                                        value="#{userList.getUserFullNameById(revision.authorId != 0 ? revision.authorId : attachment.authorId)}"/>
                            </p:column>
                            <p:column headerText="Скачать" style="width:7em">
                                <p:commandButton value="Скачать" ajax="false" onclick="PrimeFaces.monitorDownload(showStatus, hideStatus)">
                                    <p:fileDownload value="#{fileManagement.download(attachment.id, revision.version)}"/>
                                </p:commandButton>
                            </p:column>
                        </p:dataTable>
                    </p:rowExpansion>
                </p:dataTable>
                <!-- Это конечно КОСТЫЛИЩЕ, но если после первой загрузки файла делать еще один XHR запрос,
                 то следующая загрузка работает нормально. Пишут, что это связано с переходом на JSF 2.2 .
                  я-хз, долго искал и долго пытался исправить,
                 в общем каждый четный запрос XHR для fileUpload почему-то идет лесом, а нечетные - нет-->
                <p:fileUpload id="files" fileUploadListener="#{in_doc.handleFileUpload}" multiple="true" mode="advanced" widgetVar="uploadFileWidget"
                              label="Выбрать файл" sizeLimit="104857600"
                              uploadLabel="Загрузить выбранное" cancelLabel="Отмена" invalidSizeMessage="Размер файла не должен превышать 100 МБ"
                              fileLimit="3" fileLimitMessage="Не более 3-х файлов за один раз, пожалуйста"
                              update=":documentForm:msg table_attachment"
                              oncomplete="workaround(); PrimeFaces.widgets.uploadFileWidget.uploadedFileCount = PrimeFaces.widgets.uploadFileWidget.uploadedFileCount - 1;"/>
                <p:remoteCommand id="workaround" name="workaround"/>
            </p:tab>
        </p:tabView>
    </ui:define>

    <ui:define name="FOOTER">

    </ui:define>
    <ui:define name="DIALOGS">
        <p:growl id="msg"/>
        <!-- Сообщения о фактах просмотра-->
        <p:growl id="viewFactMessage" for="viewFact"/>
        <!-- Жаваскрипт для этой страницы-->
        <script type="text/javascript">
            function showStatus() {
                PF('statusDialog').show();
            }
            function hideStatus() {
                PF('statusDialog').hide();
            }
            function addRowHandlers() {
                console.log("refresh treetable row onclick handlers");
                var table_tree = document.getElementById(PrimeFaces.widgets.taskTableVar.id);
                var rows = table_tree.getElementsByClassName("task");
                for (var i = 0; i &lt; rows.length; i++) {
                    var currentRow = rows[i];
                    var createClickHandler = function (row) {
                        return function () {
                            row.className.replace('ui-state-highlight', '');
                            goToTask(row.lastChild.lastChild.value);
                        };
                    };
                    currentRow.ondblclick = createClickHandler(currentRow);
                }
            }
        </script>
        <!-- Диалог при загрузке файла -->
        <p:dialog modal="true" widgetVar="statusDialog" header="Загрузка файла" draggable="false" closable="false" resizable="false">
            <h:outputText value="Пожалуйста подождите пока ваш файл будет загружен"/>
        </p:dialog>
        <!-- Диалог работы с действиями -->
        <p:dialog id="actionDialog" widgetVar="actionDialogVar" closeable="true" modal="true" header="Действия" draggable="false"
                  resizable="false" width="50%" closeOnEscape="true" fitViewport="true">
            <h:panelGroup id="actionForm" rendered="#{in_doc.processorModal.modalVisible}">
                <h:panelGroup rendered="#{in_doc.processorModal.actionsAvailable}">
                    <p:dataTable id="action_select_table"
                                 value="#{in_doc.processorModal.availableActions}"
                                 var="row_action"
                                 width="100%"
                                 emptyMessage="Доступных действий нет"
                                 rowKey="#{row_action.action.name}"
                                 selectionMode="single"
                                 selection="#{in_doc.processorModal.selectedAction}">
                        <p:column headerText="Доступные действия">
                            <h:outputText value="#{row_action.action.name}"/>
                        </p:column>
                    </p:dataTable>
                </h:panelGroup>
                <h:panelGroup id="actiopResult"
                              rendered="#{in_doc.processorModal.noActionsAvailable or in_doc.processorModal.failureState or in_doc.processorModal.processedState}">
                    <h:outputText style="padding-left:10px;" value="#{in_doc.processorModal.actionResult}"/>
                </h:panelGroup>
                <h:panelGroup id="actionActivity" rendered="#{in_doc.processorModal.processingState}">
                    <e5ui:include data="#{in_doc.processorModal.processedActivity.document.form}"/>
                </h:panelGroup>
                <p:commandButton action="#{in_doc.processorModal.process()}"
                                 rendered="#{in_doc.processorModal.actionsAvailable or in_doc.processorModal.processingState}"
                                 value="Выполнить" update="actionForm">
                </p:commandButton>
                <p:commandButton rendered="#{in_doc.processorModal.actionsAvailable or in_doc.processorModal.processingState}"
                                 onclick="PF('actionDialogVar').close(); return false;"
                                 value="Отмена"/>
                <p:commandButton
                        rendered="#{in_doc.processorModal.noActionsAvailable or in_doc.processorModal.failureState or in_doc.processorModal.processedState}"
                        onclick="PF('actionDialogVar').close(); return false;"
                        value="Закрыть"/>
            </h:panelGroup>
        </p:dialog>
    </ui:define>

</ui:composition>

</html>