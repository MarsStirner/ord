<?xml version='1.0' encoding='UTF-8' ?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
        "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml"
      xmlns:ui="http://java.sun.com/jsf/facelets"
      xmlns:h="http://java.sun.com/jsf/html"
      xmlns:f="http://java.sun.com/jsf/core"
      xmlns:e5ui="http://efive.ru/uitemplates"
      xmlns:e5ui-comp="http://efive.ru/uitemplates/composite">

<ui:composition template="/WEB-INF/jsf-template/template.xhtml">

<ui:define name="running_head">
    <!-- #{task.document.id}  -->
    <e5ui-comp:userSessionUpdate interval="300"/>
    <h:outputScript library="js" name="datepicker.js" target="head"/>
    <h:outputScript library="js" name="datepicker-cp.js" target="head"/>
    <h:outputScript library="js" name="datepicker_init_ru.js"
                    target="head"/>
    <h:outputScript library="js" name="forms.js" target="head"/>
    <e5ui-comp:outputUtilScript/>
</ui:define>

<ui:define name="header">
    <div id="form_header">
        <div class="actionbar">
            <div class="menu">
                <div class="defbutton">
                    <h:outputLink value="#{contextPath}/component/task/tasks.xhtml">
                        <h:graphicImage value="#{resource['images:home.png']}"/>
                    </h:outputLink>
                </div>
                <div class="defbutton">
                    <h:commandLink action="#{task.edit}" rendered="#{task.viewState}">
                        <h:graphicImage value="#{resource['images:edit_buttn.png']}"/>
                        Редактировать
                    </h:commandLink>
                </div>
                <div class="defbutton">
                    <h:commandLink action="#{task.save}"
                                   rendered="#{task.editState or task.createState}">
                        <h:graphicImage value="#{resource['images:save_buttn.png']}"/>
                        Сохранить
                        <e5ui:formPartTarget formPart="editFormPart"/>
                    </h:commandLink>
                </div>
                <div class="defbutton">
                    <h:commandLink action="#{task.delete()}"
                                   rendered="#{(task.editState and task.document.getDocumentStatus().getId() eq 1)}">
                        <h:graphicImage value="#{resource['images:dell_buttn.png']}"/>
                        Удалить
                        <f:param name="docAction" value="delete"/>
                    </h:commandLink>
                </div>
                <div class="defbutton">
                    <e5ui:formPart id="actions_fp">
                        <h:commandLink
                                onclick="actionsModal.clickOpen('actionsModal'); return false;">
                            <h:graphicImage value="#{resource['images:button-do.png']}"/>
                            Действия
                        </h:commandLink>
                        <e5ui-comp:modalWindow id="actionsModal"
                                               modalWindowHolder="#{task.processorModal}"
                                               render=":main_content_form"
                                               execute="@this:modal_date selectedAction" showButtons="false"
                                               widgetVar="actionsModal">
                            <h:panelGroup
                                    rendered="#{not(task.processorModal.processingState)}">
                                <div id="title">Действия</div>
                            </h:panelGroup>
                            <h:panelGroup rendered="#{task.processorModal.actionsAvailable}">
                                <div class="wrap"
                                     style="height: 120px; background-color: #fff; clear: both;">
                                    <div class="inner" style="height: 120px;">
                                        <e5ui:dataTable id="action_select_table" border="0"
                                                        cellpadding="0" cellspacing="0"
                                                        value="#{task.processorModal.availableActions}" var="row"
                                                        grouping="false" width="100%">
                                            <e5ui:row
                                                    onclick="e5ui_util.clickElement(this, 'selectLink$');"
                                                    styleClass="#{task.processorModal.selected(row)? 'grid_row_selected': ''}"/>
                                            <e5ui:column>
                                                <f:facet name="header">
                                                    <p>Доступные действия</p>
                                                </f:facet>
                                                <h:outputText value="#{row.action.name}"/>
                                                <h:commandLink id="selectLink" style="display: none;"
                                                               rendered="#{not task.processorModal.selected(row)}"
                                                               action="#{task.processorModal.select(row)}"/>
                                            </e5ui:column>
                                        </e5ui:dataTable>
                                    </div>
                                </div>
                            </h:panelGroup>
                            <h:panelGroup
                                    rendered="#{task.processorModal.noActionsAvailable or task.processorModal.failureState or task.processorModal.processedState}">
                                <h:outputText style="padding-left:10px;"
                                              value="#{task.processorModal.actionResult}"/>
                            </h:panelGroup>
                            <h:panelGroup rendered="#{task.processorModal.processingState}">
                                <e5ui:include
                                        data="#{task.processorModal.processedActivity.document.form}"/>
                            </h:panelGroup>

                            <div class="e5ui-modal-bottombuttons">
                                <h:commandButton action="#{task.processorModal.process()}"
                                                 rendered="#{task.processorModal.actionsAvailable or task.processorModal.processingState}"
                                                 value="Выполнить"/>
                                <h:button
                                        rendered="#{task.processorModal.actionsAvailable or task.processorModal.processingState}"
                                        onclick="actionsModal.clickClose(); return false;"
                                        value="Отмена"/>
                                <h:button
                                        rendered="#{task.processorModal.noActionsAvailable or task.processorModal.failureState or task.processorModal.processedState}"
                                        onclick="actionsModal.clickClose(); return false;"
                                        value="Закрыть"/>
                            </div>
                        </e5ui-comp:modalWindow>
                    </e5ui:formPart>
                </div>

                <div class="top">
                    <h:commandLink styleClass="top_link" onclick="return false;">
							<span> <h:graphicImage
                                    value="#{resource['images:button-print.png']}"/> Печать
							</span>
                    </h:commandLink>

                    <div class="sub">
                        <div class="item">
                            <h:commandLink
                                    action='#{reports.previewSqlReportByRequestParams()}'>
                                <h:graphicImage value="#{resource['images:blank.png']}"/>
                                <f:param name="reportName" value="task_note.jrxml"/>
                                <f:param name="docId" value="#{task.document.id}"/>
                                Справка о ходе выполнения документа
                            </h:commandLink>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</ui:define>

<ui:define name="left_menu"></ui:define>

<ui:define name="content">
<div id="header_content">
    <h:panelGroup rendered="#{task.createState}">
        <div class="name">
            <h:outputText value="Новое "
                          rendered="#{task.document.form.description eq 'task'}"/>
            <h:outputText value="Новая "
                          rendered="#{task.document.form.description eq 'resolution'}"/>
            <h:outputText value="Новая "
                          rendered="#{task.document.form.description eq 'exercise'}"/>
            <h:outputText value="#{task.document.form.value.toLowerCase()}"/>
            <h:selectOneMenu id="exerciseType"
                             value="#{task.document.exerciseType}"
                             rendered="#{task.document.form.description.equals('exercise')}"
                             converter="DocumentFormConverter" immediate="true">
                <f:selectItems
                        value="#{dictionaryManagement.getDocumentFormsByCategory('Задачи')}"/>
            </h:selectOneMenu>
        </div>
        <div class="title">
            <h:outputText value="#{task.document.getDocumentStatus().getName()}"/>
        </div>
    </h:panelGroup>
    <h:panelGroup
            rendered="#{(task.editState and task.document.getDocumentStatus().getId() eq 1)}">
        <div class="name">
            <h:outputText value="#{task.document.form.value}"
                          rendered="#{task.document.form.description ne 'exercise'}"/>
            <h:selectOneMenu id="exerciseType2"
                             value="#{task.document.exerciseType}"
                             rendered="#{task.document.form.description.equals('exercise')}"
                             converter="DocumentFormConverter">
                <f:selectItems
                        value="#{dictionaryManagement.getDocumentFormsByCategory('Задачи')}"/>
            </h:selectOneMenu>
        </div>

        <div class="title">
            <h:outputText value="#{task.document.getDocumentStatus().getName()}"/>
        </div>
    </h:panelGroup>
    <h:panelGroup
            rendered="#{task.editState and task.document.getDocumentStatus().getId() ne 1}">
        <div class="name">
            <h:outputText value="#{task.document.form.value}"/>
            <h:outputText value="#{task.document.exerciseType.value}"
                          rendered="task.document.form.description.equals('exercise')"/>
            : №
            <h:outputText value="#{task.document.taskNumber}"/>
            от
            <h:outputText
                    value="#{task.document.registered? task.document.registrationDate: task.document.creationDate}">
                <f:convertDateTime type="date" pattern="dd.MM.yyyy"/>
            </h:outputText>
        </div>
        <div class="title">
            <h:outputText value="#{task.document.getDocumentStatus().getName()}"/>
        </div>
    </h:panelGroup>
    <h:panelGroup rendered="#{task.viewState}">
        <div class="name">
            <h:outputText value="#{task.document.form.value}"
                          rendered="#{task.document.form.description ne 'exercise'}"/>
            <h:outputText value="#{task.document.exerciseType.value}"
                          rendered="#{task.document.form.description.equals('exercise')}"/>
            : №
            <h:outputText value="#{task.document.taskNumber}"/>
            от
            <h:outputText
                    value="#{task.document.registered? task.document.registrationDate: task.document.creationDate}">
                <f:convertDateTime type="date" pattern="dd.MM.yyyy"/>
            </h:outputText>
        </div>
        <div class="title">
            <h:outputText value="#{task.document.getDocumentStatus().getName()}"/>
        </div>
    </h:panelGroup>
    <h:panelGroup rendered="#{task.notFoundState}">
        <div class="name">404 - Документ не найден</div>
    </h:panelGroup>
    <h:panelGroup rendered="#{task.forbiddenState}">
        <div class="name">
            403 - Действие запрещено.
            <h:outputText value="#{task.stateComment}" lang="ru"/>
        </div>
    </h:panelGroup>
    <h:panelGroup
            rendered="#{not(task.createState or task.editState or task.viewState or task.notFoundState or task.forbiddenState)}">
        <div class="name">В доступе отказано</div>
    </h:panelGroup>
</div>

<div class="main_content">
<e5ui:formPart id="editFormPart"
               rendered="#{(not task.forbiddenState)and (task.viewState or task.createState or task.editState)}">
<h:panelGroup
        rendered="#{(task.editState and (task.document.getDocumentStatus().getId() eq 1))or task.createState}">
    <div class="row">
        <table class="form_grid">
            <tr class="row">
                <td class="first"><label
                        for="main_content_form:controlDate:dateEditor"> <span
                        class="title">Срок исполнения:</span>
                </label></td>
                <td class="second"><e5ui-comp:inputDate
                        value="#{task.document.controlDate}" id="controlDate"
                        lang="ru" required="false" immediate="true"/></td>
                <td class="third"><label> <span class="title">
											<h:outputLink
                                                    title="#{(task.document.form.description eq 'resolution')?'Руководитель:':'Инициатор:'}"
                                                    onclick="initiatorSelectModalVar.clickOpen('initiatorSelectModal'); return false;">
                                                <h:outputText
                                                        value="#{(task.document.form.description eq 'resolution')?'Руководитель:':'Инициатор:'}"/>
                                            </h:outputLink>
									</span>
                </label> <e5ui-comp:modalWindow id="initiatorSelectModal"
                                                modalWindowHolder="#{task.initiatorSelectModal}"
                                                render=":main_content_form:initiator" execute="select_table"
                                                showButtons="false" style="width: 500px;"
                                                widgetVar="initiatorSelectModalVar">
                    <div id="title">
                        Выбор
                        <h:outputText
                                value="#{(task.document.form.description eq 'resolution')?'руководителя':'инициатора'}"/>
                    </div>
                    <div id="modal_container" style="margin-top: 0;">
                        <h:panelGroup
                                rendered="#{not(task.document.form.description eq 'resolution')}">
                            <div class="searchbar">
                                <span style="float: left; margin-top: 3px">Поиск:&nbsp;</span>
                                <h:inputText id="filter_string"
                                             value="#{task.initiatorSelectModal.userList.filter}"
                                             style="display:block; float:left; margin-right:10px;"
                                             title="Поиск"/>
                                <h:commandButton value=" "
                                                 action="#{task.initiatorSelectModal.userList.changePageOffset(0)}"
                                                 styleClass="searchbutton">
                                    <f:ajax
                                            execute=":main_content_form:initiatorSelectModal:filter_string"
                                            render=":main_content_form:initiatorSelectModal:ajaxModal :main_content_form:initiatorSelectModal:modal_paging"/>
                                </h:commandButton>
                            </div>
                        </h:panelGroup>

                        <div class="wrap" style="height: 300px;">
                            <div class="inner" style="height: 300px;">
                                <e5ui:dataTable id="select_table" border="0"
                                                cellpadding="0" cellspacing="0"
                                                value="#{(task.document.form.description eq 'resolution')?staffManagement.findGroupByAlias('TopManagers').membersList:task.initiatorSelectModal.userList.documents}"
                                                var="row" grouping="false" width="100%">
                                    <e5ui:row
                                            onclick="e5ui_util.clickElement(this, 'selectLink$');"
                                            styleClass="#{task.initiatorSelectModal.selected(row)? 'grid_row_selected': ''}"/>
                                    <e5ui:column>
                                        <f:facet name="header">
                                            <p>
                                                <h:outputText
                                                        value="#{(task.document.form.description eq 'resolution')?'Руководитель:':'Инициатор:'}"/>
                                            </p>
                                        </f:facet>
                                        <h:outputText value="#{row}" converter="PersonConverter"/>
                                        <h:commandLink id="selectLink" style="display: none;"
                                                       rendered="#{not task.initiatorSelectModal.selected(row)}"
                                                       action="#{task.initiatorSelectModal.select(row)}"/>
                                    </e5ui:column>
                                </e5ui:dataTable>
                            </div>
                        </div>
                        <div style="clear: both;">
                            <h:panelGroup id="modal_paging">
                                <e5ui-comp:tablePager id="pager"
                                                      documentListHolder="#{task.initiatorSelectModal.userList}"/>
                            </h:panelGroup>
                        </div>
                    </div>
                    <div class="e5ui-modal-bottombuttons">
                        <h:button
                                onclick="initiatorSelectModalVar.clickSave(); return false;"
                                value="Выбрать"/>
                        <h:button
                                onclick="initiatorSelectModalVar.clickClose(); return false;"
                                value="Отмена"/>
                    </div>
                </e5ui-comp:modalWindow></td>
                <td class="fourth"><h:outputText id="initiator"
                                                 value="#{task.document.initiator}" converter="PersonConverter"
                                                 class="wide"/></td>
            </tr>
            <tr class="row">
                <td class="first"></td>
                <td class="second"></td>
                <td class="third"><label> <span class="title">Автор</span>
                </label></td>
                <td class="fourth"><h:outputText
                        value="#{task.document.author}" converter="PersonConverter"
                        lang="ru"/></td>
            </tr>
        </table>
    </div>
</h:panelGroup>
<h:panelGroup
        rendered="#{(task.editState and (task.document.getDocumentStatus().getId() ne 1)) or task.viewState}">
    <div class="row">
        <table class="form_grid">
            <tr class="row">
                <td class="third"><label> <span class="title">Срок
											исполнения:</span>
                </label></td>
                <td class="fourth"><h:outputText
                        value="#{task.document.controlDate}">
                    <f:convertDateTime type="date" pattern="dd.MM.yyyy"/>
                </h:outputText></td>
                <td class="first"><label> <span class="title"><h:outputText
                        value="#{(task.document.form.description eq 'resolution')?'Руководитель:':'Инициатор:'}"/>
									</span>
                </label></td>
                <td class="second"><h:outputText
                        value="#{task.document.initiator}" converter="PersonConverter"
                        class="width"/></td>
            </tr>
            <tr class="row">
                <td class="first"></td>
                <td class="second"></td>
                <td class="third"><label><span class="title">Автор</span>
                </label></td>
                <td class="fourth"><h:outputText
                        value="#{task.document.author}" converter="PersonConverter"
                        lang="ru"/></td>
            </tr>
        </table>
    </div>
</h:panelGroup>
<e5ui:tabPanel id="content_table">
<e5ui:tabPage headerText="#{task.requisitesTabHeader}"
              actionBehavior="#{task.viewState? 'client': 'submit'}"
              selected="#{task.requisitesTabSelected}">
    <h:panelGroup rendered="#{task.viewState}">
        <div class="row">
            <table class="form_grid">
                <tr class="row">
                    <td class="first"><label> <span class="title">Исполнитель:</span>
                    </label></td>
                    <td class="second" colspan="3"><h:outputText
                            value="#{task.document.executor}"
                            converter="PersonConverter" class="width"/></td>
                </tr>
                <tr class="row">
                    <td class="first"><label> <span class="title">Текст:</span>
                    </label></td>
                    <td class="second" colspan="3"><h:inputTextarea rows="6"
                                                                    readonly="true"
                                                                    value="#{task.document.shortDescription}"
                                                                    class="width"/></td>
                </tr>
                <tr class="row">
                    <td class="first"><label> <span class="title">Контролер:</span>
                    </label></td>
                    <td class="second" colspan="3"><h:outputText
                            value="#{task.document.controller}"
                            converter="PersonConverter" class="width"/></td>
                </tr>
                <tr class="row">
                    <td class="first">
                        <label>
                            <span class="title">Номер в ERP</span>
                        </label>
                    </td>
                    <td class="second">
                        <h:outputText value="#{task.document.erpNumber}"/>
                    </td>
                </tr>
                <tr class="row">
                    <td class="first"></td>
                    <td class="second"></td>
                    <td class="third"></td>
                    <td class="fourth"></td>
                </tr>
            </table>
        </div>
    </h:panelGroup>
    <h:panelGroup rendered="#{task.createState or task.editState}">
        <div class="row">
            <table class="form_grid">
                <tr class="row">
                    <td class="first"><label> <span class="title">
													<h:outputLink title="Исполнитель:"
                                                                  onclick="userSelectModalVar.clickOpen('responsibleSelectModal'); return false;">
                                                        Исполнитель
                                                    </h:outputLink>
											</span>
                    </label> <e5ui-comp:modalWindow id="responsibleSelectModal"
                                                    modalWindowHolder="#{task.responsibleSelectModal}"
                                                    render=":main_content_form:responsible"
                                                    execute="select_table" showButtons="false"
                                                    style="width: 500px;" widgetVar="userSelectModalVar">
                        <div id="title">Выбор исполнителя</div>
                        <div id="modal_container" style="margin-top: 0;">
                            <div class="searchbar">
                                <span style="float: left; margin-top: 3px">Поиск:&nbsp;</span>
                                <h:inputText id="filter_string"
                                             value="#{task.responsibleSelectModal.userList.filter}"
                                             style="display:block; float:left; margin-right:10px;"
                                             title="Поиск"/>
                                <h:commandButton value=" "
                                                 action="#{task.responsibleSelectModal.userList.changePageOffset(0)}"
                                                 styleClass="searchbutton">
                                    <f:ajax
                                            execute=":main_content_form:responsibleSelectModal:filter_string"
                                            render=":main_content_form:responsibleSelectModal:select_table :main_content_form:responsibleSelectModal:modal_paging"/>
                                </h:commandButton>
                            </div>
                            <div class="wrap" style="height: 300px;">
                                <div class="inner" style="height: 300px;">
                                    <e5ui:dataTable id="select_table" border="0"
                                                    cellpadding="0" cellspacing="0"
                                                    value="#{task.responsibleSelectModal.userList.documents}"
                                                    var="row" grouping="false" width="100%">
                                        <e5ui:row
                                                onclick="e5ui_util.clickElement(this, 'selectLink$');"
                                                styleClass="#{task.responsibleSelectModal.selected(row)? 'grid_row_selected': ''}"/>
                                        <e5ui:column>
                                            <f:facet name="header">
                                                <p>Исполнитель</p>
                                            </f:facet>
                                            <h:outputText value="#{row}"
                                                          converter="PersonConverter"/>
                                            <h:commandLink id="selectLink" style="display: none;"
                                                           rendered="#{not task.responsibleSelectModal.selected(row)}"
                                                           action="#{task.responsibleSelectModal.select(row)}"/>
                                        </e5ui:column>
                                    </e5ui:dataTable>
                                </div>
                            </div>
                            <div style="clear: both;">
                                <h:panelGroup id="modal_paging">
                                    <e5ui-comp:tablePager id="pager"
                                                          documentListHolder="#{task.responsibleSelectModal.userList}"/>
                                </h:panelGroup>
                            </div>
                        </div>
                        <div class="e5ui-modal-bottombuttons">
                            <h:button
                                    onclick="userSelectModalVar.clickSave(); return false;"
                                    value="Выбрать"/>
                            <h:button
                                    onclick="userSelectModalVar.clickClose(); return false;"
                                    value="Отмена"/>
                        </div>
                    </e5ui-comp:modalWindow></td>
                    <td class="second" colspan="3"><h:outputText
                            id="responsible" value="#{task.document.executor}"
                            converter="PersonConverter" class="wide"/></td>
                </tr>
                <tr class="row">
                    <td class="first"><label
                            for="main_content_form:shortDescription"> <span
                            class="title">Текст:</span>
                    </label></td>
                    <td class="second" colspan="3"><h:inputTextarea rows="6"
                                                                    id="shortDescription"
                                                                    value="#{task.document.shortDescription}"
                                                                    class="wide"
                                                                    immediate="true"/></td>
                </tr>
                <tr class="row">
                    <td class="first"><label> <span class="title">
													<h:outputLink title="Контролер:"
                                                                  onclick="controllerSelectModalVar.clickOpen('controllerSelectModal'); return false;">
                                                        Контролер
                                                    </h:outputLink>
											</span>
                    </label> <e5ui-comp:modalWindow id="controllerSelectModal"
                                                    modalWindowHolder="#{task.controllerSelectModal}"
                                                    render=":main_content_form:controller"
                                                    execute="select_table" showButtons="false"
                                                    style="width: 500px;" widgetVar="controllerSelectModalVar">
                        <div id="title">Выбор исполнителя</div>
                        <div id="modal_container" style="margin-top: 0;">
                            <div class="searchbar">
                                <span style="float: left; margin-top: 3px">Поиск:&nbsp;</span>
                                <h:inputText id="filter_string"
                                             value="#{task.controllerSelectModal.userList.filter}"
                                             style="display:block; float:left; margin-right:10px;"
                                             title="Поиск"/>
                                <h:commandButton value=" "
                                                 action="#{task.controllerSelectModal.userList.changePageOffset(0)}"
                                                 styleClass="searchbutton">
                                    <f:ajax
                                            execute=":main_content_form:controllerSelectModal:filter_string"
                                            render=":main_content_form:controllerSelectModal:select_table :main_content_form:controllerSelectModal:modal_paging"/>
                                </h:commandButton>
                            </div>
                            <div class="wrap" style="height: 300px;">
                                <div class="inner" style="height: 300px;">
                                    <e5ui:dataTable id="select_table" border="0"
                                                    cellpadding="0" cellspacing="0"
                                                    value="#{task.controllerSelectModal.userList.documents}"
                                                    var="row" grouping="false" width="100%">
                                        <e5ui:row
                                                onclick="e5ui_util.clickElement(this, 'selectLink$');"
                                                styleClass="#{task.controllerSelectModal.selected(row)? 'grid_row_selected': ''}"/>
                                        <e5ui:column>
                                            <f:facet name="header">
                                                <p>Контролер</p>
                                            </f:facet>
                                            <h:outputText value="#{row}"
                                                          converter="PersonConverter"/>
                                            <h:commandLink id="selectLink" style="display: none;"
                                                           rendered="#{not task.controllerSelectModal.selected(row)}"
                                                           action="#{task.controllerSelectModal.select(row)}"/>
                                        </e5ui:column>
                                    </e5ui:dataTable>
                                </div>
                            </div>
                            <div style="clear: both;">
                                <h:panelGroup id="modal_paging">
                                    <e5ui-comp:tablePager id="pager"
                                                          documentListHolder="#{task.controllerSelectModal.userList}"/>
                                </h:panelGroup>
                            </div>
                        </div>
                        <div class="e5ui-modal-bottombuttons">
                            <h:button
                                    onclick="controllerSelectModalVar.clickSave(); return false;"
                                    value="Выбрать"/>
                            <h:button
                                    onclick="controllerSelectModalVar.clickClose(); return false;"
                                    value="Отмена"/>
                        </div>
                    </e5ui-comp:modalWindow></td>
                    <td class="second" colspan="3"><h:outputText
                            id="controller" value="#{task.document.controller}"
                            converter="PersonConverter" class="wide"/></td>
                </tr>
                <tr class="row">
                    <td class="first">
                        <label>
                            <span class="title">Номер в ERP</span>
                        </label>
                    </td>
                    <td class="second">
                        <h:inputText value="#{task.document.erpNumber}"/>
                    </td>
                </tr>
                <tr>
                    <td class="first"></td>
                    <td class="second"></td>
                    <td class="third"></td>
                    <td class="fourth"></td>
                </tr>
            </table>
        </div>
    </h:panelGroup>
</e5ui:tabPage>
<e5ui:tabPage headerText="#{task.routeTabHeader}"
              actionBehavior="client" selected="#{task.routeTabSelected}">
    <fieldset>
        <legend>Поручения</legend>
        <script type="text/javascript">
            document.ondblclick = function DoubleClick(evt) {
                if (window.getSelection)
                    window.getSelection().removeAllRanges();
                else if (document.selection)
                    document.selection.empty();
            }
        </script>
        <h:outputScript>
            function goToDocument(id) {
            if (id != "") {
            window.open('#{facesContext.externalContext.requestContextPath}/component/task/task.xhtml?docId=' + id,'_blank');
            }
            }
        </h:outputScript>

        <div class="actionbar">
            <div class="menu">
                <h:panelGroup rendered="#{task.document.getDocumentStatus().getId()==2}">
                    <div class="defbutton">
                        <h:outputLink value="#{contextPath}/component/task/task.xhtml"
                                      target="_blank">
                            <h:graphicImage
                                    value="#{resource['images:newf_buttn_icon.png']}"/>
                            Новое поручение
                            <f:param name="docAction" value="create"/>
                            <f:param name="formId" value="task"/>
                            <f:param name="parentId" value="#{task.document.uniqueId}"/>
                            <f:param name="rootDocumentId"
                                     value="#{(task.document.rootDocumentId==null || task.document.rootDocumentId.isEmpty())? task.document.uniqueId : task.document.rootDocumentId}"/>
                        </h:outputLink>
                    </div>
                </h:panelGroup>

                <div class="defbutton">
                    <h:commandLink action="false;">
                        <f:ajax render=":main_content_form:descendant_table"/>
                        <h:graphicImage
                                value="#{resource['images:button-refresh.png']}"/>
                        Обновить
                    </h:commandLink>
                </div>
            </div>
        </div>
        <h:panelGroup>
            <div id="modal_container" style="margin-top: 0;">
                <div class="wrap" style="height: 250px;">
                    <div class="inner" style="height: 250px;">
                        <e5ui:dataTable id="descendant_table" border="0"
                                        cellpadding="0" cellspacing="0"
                                        value="#{tasks.getDocumentsTreeByParent(task.document.uniqueId)}"
                                        var="row" grouping="true" levelCount="10" style="width:100%">
                            <e5ui:row ondblclick="goToDocument('#{row.id}');"
                                      level="#{row.grouping}" group="#{row.parent}"
                                      fullRow="false" collapsed="false">
                                <f:facet name="fullRowDefault">
                                    <b><h:outputText value="#{row.taskNumber}"/> </b>
                                </f:facet>
                            </e5ui:row>
                            <e5ui:column>
                                <f:facet name="header">
                                    <p>Номер</p>
                                </f:facet>
                                <h:outputText value="#{row.taskNumber}"/>
                            </e5ui:column>
                            <e5ui:column>
                                <f:facet name="header">
                                    <p>Исполнитель</p>
                                </f:facet>
                                <h:outputText value="#{row.executor}"
                                              converter="PersonConverter"/>
                            </e5ui:column>
                            <e5ui:column>
                                <f:facet name="header">
                                    <p>Срок исполнения</p>
                                </f:facet>
                                <h:outputText value="#{row.controlDate}">
                                    <f:convertDateTime type="date" pattern="dd.MM.yyyy"/>
                                </h:outputText>
                            </e5ui:column>
                            <e5ui:column>
                                <f:facet name="header">
                                    <p>Автор</p>
                                </f:facet>
                                <h:outputText value="#{row.author.description}"/>
                            </e5ui:column>
                            <e5ui:column>
                                <f:facet name="header">
                                    <p>Содержание</p>
                                </f:facet>
                                <h:outputText value="#{row.shortDescription}"/>
                            </e5ui:column>
                            <e5ui:column>
                                <f:facet name="header">
                                    <p>Статус</p>
                                </f:facet>
                                <h:outputText value="#{row.getDocumentStatus().getName()}"/>
                            </e5ui:column>
                        </e5ui:dataTable>
                    </div>
                </div>
            </div>
        </h:panelGroup>
    </fieldset>
</e5ui:tabPage>
<e5ui:tabPage headerText="#{task.relationTabHeader}"
              actionBehavior="client" selected="#{task.relationTabSelected}">
    <h:outputScript>
        function goToDocumentByParentId(parentId) {
        if (parentId != "") {
        var pos=parentId.indexOf('_');
        if(pos!=-1){
        var id=parentId.substring(pos+1,parentId.length);
        if(parentId.indexOf('incoming')!=-1){
        componentType='in/in_document';
        }else if(parentId.indexOf('outgoing')!=-1){
        componentType='out/out_document';
        }else if(parentId.indexOf('internal')!=-1){
        componentType='internal/internal_document';
        }else if(parentId.indexOf('request')!=-1){
        componentType='request/request_document';
        }else if(parentId.indexOf('task')!=-1){
        componentType='task/task';
        }
        window.open('#{facesContext.externalContext.requestContextPath}/component/'+componentType+'.xhtml?docId=' + id,'_blank');
        }
        }
        }
    </h:outputScript>
    <h:panelGroup
            rendered="#{(task.document.parentId!=null)and(task.document.parentId.length()>0)}">
        <div class="row">
            <table class="form_grid">
                <tr class="row">
                    <td class="first"><label> <span class="title">Документ
													основание:</span>
                    </label></td>
                    <td class="second" colspan="3"><h:outputLink
                            style="margin-left:5px;" value="#"
                            onclick="goToDocumentByParentId('#{task.document.parentId}');">
                        <h:graphicImage value="#{resource['images:link.png']}"/>
                        <h:outputText
                                value="#{task.getLinkDescriptionById(task.document.parentId)}"/>
                    </h:outputLink></td>
                </tr>
                <tr class="row">
                    <td class="first"></td>
                    <td class="second"></td>
                    <td class="third"></td>
                    <td class="'fourth"></td>
                </tr>
            </table>
        </div>
    </h:panelGroup>
</e5ui:tabPage>

<e5ui:tabPage headerText="#{task.historyTabHeader}"
              actionBehavior="client" selected="#{task.historyTabSelected}">
    <fieldset>
        <legend>
            <label><span class="title">История</span> </label>
        </legend>
        <div class="wrap" style="width: 100%; margin: 0px">
            <div class="inner">
                <e5ui:dataTable border="0" cellpadding="0" cellspacing="0"
                                id="history_list" value="#{task.document.historyList}"
                                var="row" grouping="false">
                    <e5ui:column>
                        <f:facet name="header">
                            <p>Дата</p>
                        </f:facet>
                        <h:outputText value="#{row.startDate}">
                            <f:convertDateTime type="date" pattern="dd.MM.yyyy HH:mm"/>
                        </h:outputText>
                    </e5ui:column>
                    <e5ui:column>
                        <f:facet name="header">
                            <p>Статус</p>
                        </f:facet>
                        <h:outputText value="#{row.fromStatusName}"/>
                    </e5ui:column>
                    <e5ui:column>
                        <f:facet name="header">
                            <p>Действие</p>
                        </f:facet>
                        <h:outputText value="#{row.actionName}"/>
                    </e5ui:column>
                    <e5ui:column>
                        <f:facet name="header">
                            <p>Автор</p>
                        </f:facet>
                        <h:outputText value="#{row.owner.descriptionShort}"/>
                    </e5ui:column>
                    <e5ui:column>
                        <f:facet name="header">
                            <p>Комментарий</p>
                        </f:facet>
                        <h:outputText value="#{row.commentary}"/>
                    </e5ui:column>
                </e5ui:dataTable>
            </div>
        </div>
    </fieldset>
</e5ui:tabPage>
</e5ui:tabPanel>
</e5ui:formPart>
</div>
</ui:define>

<ui:define name="footer">
<h:form id="file_upload_form" enctype="multipart/form-data">
    <div style="padding-top: 10px;">
        <fieldset>
            <legend>Файлы</legend>
            <div class="menu">
                <div class="defbutton">
                    <e5ui:fileUpload id="file_upload" multiple="true"
                                     actionBehavior="separate" maxFilesCount="0"
                                     uploadHandler="#{fileManagement.uploadHandler}"
                                     action="#{task.uploadAttachments(fileManagement.details)}"
                                     onuploading="e5ui_ajaxStatus.ajsgStopped=true;splash_screen_2.startShow();"
                                     onuploaded="splash_screen_2.stopShow();e5ui_ajaxStatus.ajsgStopped=false;">
                        <f:ajax render=":file_upload_form"/>
                    </e5ui:fileUpload>
                </div>
                <div class="defbutton">
                    <h:commandLink action="#{task.updateAttachments()}">
                        <h:graphicImage value="#{resource['images:button-refresh.png']}"/>
                        Обновить
                        <f:ajax render=":file_upload_form"/>
                    </h:commandLink>
                </div>
            </div>
            <div style="margin-top: 10px;">
                <div class="wrap_main" id="table_wrap">
                    <div class="inner" id="table_inner">
                        <e5ui:dataTable border="0" cellpadding="0" cellspacing="0"
                                        id="file_table" value="#{task.attachments}" var="row">
                            <e5ui:column>
                                <h:outputText value="#{row.currentRevision.fileName}"/>
                            </e5ui:column>
                            <e5ui:column>
                                <h:outputText value="#{row.currentRevision.version}"/>
                            </e5ui:column>
                            <e5ui:column>
                                <h:outputText
                                        value="#{userList.getUserDescription(row.currentRevision.authorId)}"/>
                            </e5ui:column>
                            <e5ui:column>
                                <h:outputLink
                                        value="#{contextPath}/component/file/download.xhtml"
                                        target="_blank">
                                    <h:graphicImage value="/resources/images/download_doc.gif"/>
                                    <f:param name="id" value="#{row.id}"/>
                                    Скачать
                                </h:outputLink>
                            </e5ui:column>
                            <e5ui:column>
                                <h:commandLink action="#{task.initializeVersionAppender(row)}">
                                    <h:graphicImage value="/resources/images/CheckOut_icon.gif"/>
                                    <f:ajax render=":file_upload_form"/>
                                    Добавить версию документа
                                </h:commandLink>
                            </e5ui:column>
                            <e5ui:column>
                                <h:commandLink action="#{task.initializeVersionHistory(row)}">
                                    <h:graphicImage value="/resources/images/CheckOut_icon.gif"/>
                                    <f:ajax render=":file_upload_form"/>
                                    История версий
                                </h:commandLink>
                            </e5ui:column>
                            <e5ui:column>
                                <h:commandLink action="#{task.deleteAttachment(row)}">
                                    <h:graphicImage value="/resources/images/delete.gif"/>
                                    <f:ajax render=":file_upload_form :main_content_form"/>
                                    Удалить
                                </h:commandLink>
                            </e5ui:column>
                        </e5ui:dataTable>

                        <e5ui-comp:modalWindow id="versionAppenderModal"
                                               modalWindowHolder="#{task.versionAppenderModal}"
                                               render=":file_upload_form" execute=":file_upload_form"
                                               style="width:300px;" showButtons="false"
                                               widgetVar="versionAppenderModal">
                            <div id="title">Добавление версии документа</div>
                            <div id="modal_container" style="margin-top: 0;">
                                <div>
                                    Документ:
                                    <h:outputText
                                            value="#{task.versionAppenderModal.attachment.currentRevision.fileName}"/>
                                </div>
                                <div>
                                    Текущая версия:
                                    <h:outputText
                                            value="#{task.versionAppenderModal.attachment.currentRevision.version}"/>
                                </div>
                                <div>
                                    <h:selectBooleanCheckbox
                                            value="#{task.versionAppenderModal.majorVersion}"/>
                                    Увеличить старший номер
                                </div>
                                <div style="margin-top: 5px;">
                                    <e5ui:fileUpload id="version_upload" multiple="false"
                                                     actionBehavior="separate" maxFilesCount="1"
                                                     uploadHandler="#{fileManagement.uploadHandler}"
                                                     action="#{task.versionAppenderModal.saveAttachment}"
                                                     onuploading="e5ui_ajaxStatus.ajsgStopped=true;splash_screen_2.startShow();"
                                                     onuploaded="splash_screen_2.stopShow();e5ui_ajaxStatus.ajsgStopped=false;">
                                        <f:ajax render=":file_upload_form"
                                                execute=":file_upload_form:versionAppenderModal"/>
                                    </e5ui:fileUpload>
                                </div>
                            </div>
                            <div class="e5ui-modal-bottombuttons">
                                <h:button
                                        onclick="versionAppenderModal.clickClose(); return false;"
                                        value="Отмена"/>
                            </div>
                        </e5ui-comp:modalWindow>

                        <e5ui-comp:modalWindow id="versionHistoryModal"
                                               modalWindowHolder="#{task.versionHistoryModal}"
                                               render=":file_upload_form" execute=":file_upload_form"
                                               style="width:500px;" showButtons="false"
                                               widgetVar="versionHistoryModal">
                            <div id="title">История версий документа</div>
                            <div id="modal_container" style="margin-top: 0;">
                                <div class="wrap_main" id="table_wrap">
                                    <div class="inner" id="table_inner">
                                        <e5ui:dataTable border="0" cellpadding="0" cellspacing="0"
                                                        id="version_table"
                                                        value="#{task.versionHistoryModal.versionList}" var="row">
                                            <e5ui:column style="min-width:8em;">
                                                <h:outputText
                                                        value="#{row.fileName eq null? task.versionHistoryModal.attachment.fileName: row.fileName}"/>
                                            </e5ui:column>
                                            <e5ui:column style="min-width:5em;">
                                                <h:outputText value="#{row.version}"/>
                                            </e5ui:column>
                                            <e5ui:column style="min-width:12em;">
                                                <h:outputText
                                                        value="#{userList.getUserDescription(row.authorId eq 0? task.versionHistoryModal.attachment.authorId: row.authorId)}"/>
                                            </e5ui:column>
                                            <e5ui:column style="min-width:7em;">
                                                <h:outputLink
                                                        value="#{contextPath}/component/file/download.xhtml"
                                                        target="_blank">
                                                    <h:graphicImage
                                                            value="/resources/images/download_doc.gif"/>
                                                    <f:param name="id"
                                                             value="#{task.versionHistoryModal.attachment.id}"/>
                                                    <f:param name="revision" value="#{row.version}"/>
                                                    Скачать
                                                </h:outputLink>
                                            </e5ui:column>
                                        </e5ui:dataTable>
                                    </div>
                                </div>
                            </div>
                            <div class="e5ui-modal-bottombuttons">
                                <h:button
                                        onclick="versionHistoryModal.clickClose(); return false;"
                                        value="Закрыть"/>
                            </div>
                        </e5ui-comp:modalWindow>
                    </div>
                </div>
            </div>
        </fieldset>
    </div>

    <e5ui-comp:splashScreen id="splash_screen_2"
                            widgetVar="splash_screen_2" timeout="0">
        <f:facet name="timeoutPanel">
            <div
                    style="background-color: white; border-top: solid 1px black; border-bottom: solid 1px black; padding: 30px; text-align: center; margin: 200px auto; width: 300px;">
                Пожалуйста, подождите...
            </div>
        </f:facet>
    </e5ui-comp:splashScreen>
    <script>
        e5ui_splashScreen.startShowOnSubmit('splash_screen_2',
                [ 'file_upload_form' ]);
    </script>
</h:form>

<e5ui:multiMarker id="main_form_marker" rendered="true"
                  hintWindowStyleClass="e5ui-marker-hintWindow"
                  hintWindowInfoStyleClass="e5ui-marker-hintWindow-info"
                  hintWindowWarnStyleClass="e5ui-marker-hintWindow-warn"
                  hintWindowErrorStyleClass="e5ui-marker-hintWindow-error"
                  hintWindowFatalStyleClass="e5ui-marker-hintWindow-fatal"
                  displayMode="window">
    <h:button
            onclick="e5ui_multiMarker.remove('main_form_marker'); return false;"
            value="ОК"/>
</e5ui:multiMarker>
<e5ui-comp:splashScreen id="splash_screen" timeout="0">
    <f:facet name="timeoutPanel">
        <div
                style="background-color: white; border-top: solid 1px black; border-bottom: solid 1px black; padding: 30px; text-align: center; margin: 200px auto; width: 300px;">
            Пожалуйста, подождите...
        </div>
    </f:facet>
</e5ui-comp:splashScreen>
<script>
    e5ui_splashScreen.startShowOnSubmit('splash_screen',
            [ 'main_content_form' ]);
</script>
<h:outputStylesheet library="css" name="datepicker.css"/>
<h:outputStylesheet library="css" name="datatable.css"/>
<h:outputStylesheet library="css" name="modalWindow.css"/>
<h:outputStylesheet library="css" name="multiMarker.css"/>
<h:outputStylesheet library="css" name="tabPanel.css"/>
</ui:define>


</ui:composition>

</html>