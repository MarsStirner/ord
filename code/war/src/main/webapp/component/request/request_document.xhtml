<?xml version='1.0' encoding='UTF-8' ?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml"
      xmlns:ui="http://java.sun.com/jsf/facelets"
      xmlns:h="http://java.sun.com/jsf/html"
      xmlns:f="http://java.sun.com/jsf/core"
      xmlns:e5ui="http://efive.ru/uitemplates"
      xmlns:e5ui-comp="http://efive.ru/uitemplates/composite"
      xmlns:p="http://primefaces.org/ui"
      xmlns:my = "http://xmlns.jcp.org/jsf/composite/mycomponents"
        >

<ui:composition template="/jsf-template/template.xhtml">

    <ui:define name="running_head">
        <h:outputScript library="js" name="primefacesLocale_ru.js"/>
        <h:outputStylesheet library="css" name="primefacesExtension/calendarIcon.css"/>
    </ui:define>

    <ui:define name="header">
        <div id="form_header">
            <div class="actionbar">
                <div class="menu">
                    <div class="defbutton">
                        <h:outputLink value="/component/request/request_documents.xhtml">
                            <h:graphicImage value="#{resource['images:home.png']}"/>
                        </h:outputLink>
                    </div>
                    <div class="defbutton">
                        <p:commandLink action="#{request_doc.edit}" rendered="#{request_doc.viewState and request_doc.editPermission}" update="@all">
                            <h:graphicImage value="#{resource['images:edit_buttn.png']}"/>
                            Редактировать
                        </p:commandLink>
                    </div>
                    <div class="defbutton">
                        <p:commandLink action="#{request_doc.save}" rendered="#{request_doc.editState or request_doc.createState}" update="@all">
                            <h:graphicImage value="#{resource['images:save_buttn.png']}"/>
                            Сохранить
                        </p:commandLink>
                    </div>
                    <div class="defbutton">
                        <e5ui:formPart id="actions_fp">
                            <p:commandLink onstart="actionsModal.clickOpen('actionsModal'); return false;" rendered="#{request_doc.executePermission and request_doc.viewState}">
                                <h:graphicImage value="#{resource['images:button-do.png']}"/>
                                Действия
                            </p:commandLink>
                            <e5ui-comp:modalWindow id="actionsModal"
                                                   modalWindowHolder="#{request_doc.processorModal}"
                                                   render=":main_content_form" execute="selectedAction"
                                                   showButtons="false" widgetVar="actionsModal">
                                <h:panelGroup rendered="#{not(request_doc.processorModal.processingState)}">
                                    <div id="title">Действия</div>
                                </h:panelGroup>
                                <h:panelGroup rendered="#{request_doc.processorModal.actionsAvailable}">
                                    <div class="wrap" style="height: 90px; background-color: #fff; clear: both;">
                                        <div class="inner" style="height: 90px;">
                                            <e5ui:dataTable id="action_select_table" border="0"
                                                            cellpadding="0" cellspacing="0"
                                                            value="#{request_doc.processorModal.availableActions}"
                                                            var="row" grouping="false" width="100%">
                                                <e5ui:row
                                                        onclick="e5ui_util.clickElement(this, 'selectLink$');"
                                                        styleClass="#{request_doc.processorModal.selected(row)? 'grid_row_selected': ''}"/>
                                                <e5ui:column>
                                                    <f:facet name="header">
                                                        <p>Доступные действия</p>
                                                    </f:facet>
                                                    <h:outputText value="#{row.action.name}"/>
                                                    <h:commandLink id="selectLink" style="display: none;"
                                                                   rendered="#{not request_doc.processorModal.selected(row)}"
                                                                   action="#{request_doc.processorModal.select(row)}"/>
                                                </e5ui:column>
                                            </e5ui:dataTable>
                                        </div>
                                    </div>
                                </h:panelGroup>
                                <h:panelGroup rendered="#{request_doc.processorModal.noActionsAvailable or request_doc.processorModal.failureState or request_doc.processorModal.processedState}">
                                    <div style="padding-left: 10px;">
                                        <ui:repeat value="#{request_doc.processorModal.actionResult.split(':')}" var="element">
                                            <h:outputText value="#{element}"/><br/>
                                        </ui:repeat>
                                    </div>
                                </h:panelGroup>
                                <h:panelGroup rendered="#{request_doc.processorModal.processingState}">
                                    <e5ui:include data="#{request_doc.processorModal.processedActivity.document.form}"/>
                                </h:panelGroup>
                                <div class="e5ui-modal-bottombuttons">
                                    <h:commandButton
                                            action="#{request_doc.processorModal.process()}"
                                            rendered="#{request_doc.processorModal.actionsAvailable or request_doc.processorModal.processingState}"
                                            value="Выполнить"/>
                                    <h:button
                                            rendered="#{request_doc.processorModal.actionsAvailable or request_doc.processorModal.processingState}"
                                            onclick="actionsModal.clickClose(); return false;"
                                            value="Отмена"/>
                                    <h:button
                                            rendered="#{request_doc.processorModal.noActionsAvailable or request_doc.processorModal.failureState or request_doc.processorModal.processedState}"
                                            onclick="actionsModal.clickClose(); return false;"
                                            value="Закрыть"/>
                                </div>
                            </e5ui-comp:modalWindow>
                        </e5ui:formPart>
                    </div>
                    <div class="top">
                        <h:commandLink styleClass="top_link" onclick="return false;">
							<span>
                                <h:graphicImage value="#{resource['images:button-print.png']}"/>
                                Печать
							</span>
                        </h:commandLink>
                        <div class="sub">
                            <div class="item">
                                <h:commandLink action='#{reports.previewSqlReportByRequestParams()}'>
                                    <h:graphicImage value="#{resource['images:blank.png']}"/>
                                    <f:param name="reportName" value="request_note.jrxml"/>
                                    <f:param name="docId" value="#{request_doc.document.id}"/>
                                    Справка о ходе выполнения документа
                                </h:commandLink>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </ui:define>

    <ui:define name="left_menu"/>

    <ui:define name="content">
        <p:growl id="viewFactMessage" for="viewFact"/>

        <div id="header_content">
            <div class="name">
                Обращение
                <!--Давать выбирать вид документа на основании его статусов "На регистрации\Зарегистрирован\На исполнении"-->
                <ui:param name="statusId_In_ON_REG_OR_CKECKIN_OR_ON_EXEC"
                          value="#{request_doc.document.documentStatus.id eq 1 or request_doc.document.documentStatus.id eq 2 or request_doc.document.documentStatus.id eq 80}"/>
                <p:selectOneMenu id="form" value="#{request_doc.document.form}" converter="RequestDocumentFormConverter"
                                 rendered="#{request_doc.createState or (request_doc.editState and statusId_In_ON_REG_OR_CKECKIN_OR_ON_EXEC)}">
                    <f:selectItems value="#{dictionaryManagement.getDocumentFormsByCategory('REQUEST')}"/>
                </p:selectOneMenu>
                <h:outputText value="#{request_doc.document.form}" rendered="#{request_doc.viewState or (request_doc.editState and not statusId_In_ON_REG_OR_CKECKIN_OR_ON_EXEC)}"/>
                <h:outputText value=" № #{request_doc.document.registrationNumber} от " rendered="#{request_doc.editState or request_doc.viewState}"/>
                <h:outputText value="#{request_doc.document.deliveryDate}">
                    <f:convertDateTime type="date" pattern="dd.MM.yyyy"/>
                </h:outputText>
            </div>
            <div class="title">
                <h:outputText value="#{request_doc.document.getDocumentStatus().getName()}"/>
            </div>
            <h:panelGroup rendered="#{request_doc.notFoundState}">
                <div class="name">
                    404 - Документ не найден
                </div>
            </h:panelGroup>
            <h:panelGroup rendered="#{request_doc.forbiddenState}">
                <div class="name">
                    403 - Действие запрещено.
                    <h:outputText value="#{request_doc.stateComment}"/>
                </div>
            </h:panelGroup>
            <h:panelGroup rendered="#{not(request_doc.createState or request_doc.editState or request_doc.viewState or request_doc.notFoundState or request_doc.forbiddenState)}">
                <div class="name">В доступе отказано</div>
            </h:panelGroup>
        </div>

        <div class="main_content">
            <h:panelGroup rendered="#{request_doc.createState or (request_doc.editState and request_doc.document.registrationNumber==null)}">
                <div class="row">
                    <table class="form_grid">
                        <tr class="row">
                            <td class="first">
                                <label for="deliveryDate">
                                    <span class="title">Дата поступления: </span>
                                </label>
                            </td>
                            <td class="second">
                                <p:calendar id="deliveryDate" value="#{request_doc.document.deliveryDate}" lang="ru" locale="ru"
                                            widgetVar="deliveryDateVar" pattern="dd.MM.yyyy" showOn="both"/>
                            </td>
                            <td class="third">
                                <label for="author_1">
                                    <span class="title">Автор: </span>
                                </label>
                            </td>
                            <td class="fourth">
                                <h:outputText id="author_1" value="#{request_doc.document.author.getDescription()}"/>
                            </td>
                        </tr>
                        <tr class="row">
                            <td class="first">
                                <label for="executionDate">
                                    <span class="title">Срок исполнения: </span>
                                </label>
                            </td>
                            <td class="second">
                                <p:calendar id="executionDate" value="#{request_doc.document.executionDate}" lang="ru" locale="ru"
                                            widgetVar="executionDateVar" pattern="dd.MM.yyyy" showOn="both"/>
                            </td>
                            <td class="third">
                                <p:commandLink actionListener="#{request_doc.chooseResponsible}" ajax="true" value="Ответственный исполнитель">
                                    <p:ajax event="dialogReturn" listener="#{request_doc.onResponsibleChosen}" update="responsible"/>
                                </p:commandLink>
                            </td>
                            <td class="fourth">
                                <h:outputText id="responsible" value="#{request_doc.document.responsible.getDescription()}" class="wide"/>
                            </td>
                        </tr>
                    </table>
                </div>
            </h:panelGroup>
            <h:panelGroup rendered="#{(request_doc.editState and request_doc.document.registrationNumber!=null) or request_doc.viewState}">
                <div class="row">
                    <table class="form_grid">
                        <tr class="row">
                            <td class="first">
                                <label>
                                    <span class="title">Дата поступления: </span>
                                </label>
                            </td>
                            <td class="second">
                                <h:outputText value="#{request_doc.document.deliveryDate}" lang="ru">
                                    <f:convertDateTime type="date" pattern="dd.MM.yyyy"/>
                                </h:outputText>
                            </td>
                            <td class="third">
                                <label>
                                    <span class="title">Автор:</span>
                                </label>
                            </td>
                            <td class="fourth">
                                <h:outputText id="author" value="#{request_doc.document.author.getDescription()}"/>
                            </td>
                        </tr>
                        <tr class="row">
                            <td class="first">
                                <label>
                                    <span class="title">Срок исполнения: </span>
                                </label>
                            </td>
                            <td class="second">
                                <h:outputText value="#{request_doc.document.executionDate}" lang="ru">
                                    <f:convertDateTime type="date" pattern="dd.MM.yyyy"/>
                                </h:outputText>
                            </td>
                            <td class="third">
                                <label>
                                    <span class="title">Ответственный исполнитель: </span>
                                </label>
                            </td>
                            <td class="fourth">
                                <h:outputText value="#{request_doc.document.responsible.getDescription()}" class="wide"/>
                            </td>
                        </tr>
                    </table>
                </div>
            </h:panelGroup>
            <p:tabView id="content_table" widgetVar="requestDocumentTabViewVar" activeIndex="0" effect="fade" effectDuration="fast">
                <p:tab title="Реквизиты" rendered="#{request_doc.viewState or request_doc.createState or request_doc.editState}">
                    <h:panelGroup rendered="#{request_doc.viewState}">
                        <div class="row">
                            <table class="form_grid">
                                <tr class="row">
                                    <td class="first">
                                        <label>
                                            <span class="title">Тип	доставки:</span>
                                        </label>
                                    </td>
                                    <td class="second">
                                        <h:outputText value="#{request_doc.document.deliveryType.value}"/>
                                    </td>
                                    <td class="third"/>
                                    <td class="fourth"/>
                                </tr>
                                <tr class="row">
                                    <td class="first">
                                        <label>
                                            <span class="title">Тип	отправителя:</span>
                                        </label>
                                    </td>
                                    <td class="second">
                                        <h:outputText value="#{request_doc.document.senderType.value}"/>
                                    </td>
                                    <td class="third"/>
                                    <td class="fourth"/>
                                </tr>
                                <tr class="row">
                                    <td class="first">
                                        <label>
                                            <span class="title">Регион:</span>
                                        </label>
                                    </td>
                                    <td class="second">
                                        <h:outputText value="#{request_doc.document.region}" converter="RegionConverter"/>
                                    </td>
                                    <td class="third"/>
                                    <td class="fourth"/>
                                </tr>
                                <h:panelGroup rendered="#{request_doc.document.senderType.value.equals('Юридическое лицо')}">
                                    <tr class="row">
                                        <td class="first">
                                            <label>
                                                <span class="title">Корреспондент</span>
                                            </label>
                                        </td>
                                        <td class="second">
                                            <h:outputText value="#{request_doc.document.contragent.value}"/>
                                        </td>
                                        <td class="third"/>
                                        <td class="fourth"/>
                                    </tr>
                                </h:panelGroup>
                                <h:panelGroup rendered="#{request_doc.document.senderType.value.equals('Физическое лицо') or request_doc.document.senderType.value.equals('Юридическое лицо')}">
                                    <tr class="row">
                                        <td class="first">
                                            <label>
                                                <span class="title">Фамилия:</span>
                                            </label>
                                        </td>
                                        <td class="second" colspan="3">
                                            <strong>
                                                <h:outputText value="#{request_doc.document.senderLastName}" class="wide"/>
                                            </strong>
                                        </td>
                                    </tr>
                                    <tr class="row">
                                        <td class="first">
                                            <label>
                                                <span class="title">Имя:</span>
                                            </label>
                                        </td>
                                        <td class="second" colspan="3">
                                            <strong>
                                                <h:outputText value="#{request_doc.document.senderFirstName}" class="wide"/>
                                            </strong>
                                        </td>
                                    </tr>
                                    <tr class="row">
                                        <td class="first">
                                            <label>
                                                <span class="title">Отчество:</span>
                                            </label>
                                        </td>
                                        <td class="second" colspan="3">
                                            <strong>
                                                <h:outputText value="#{request_doc.document.senderMiddleName}" class="wide"/>
                                            </strong>
                                        </td>
                                    </tr>
                                </h:panelGroup>
                                <tr class="row">
                                    <td class="first">
                                        <label>
                                            <span class="title">Краткое	содержание:</span>
                                        </label>
                                    </td>
                                    <td class="second" colspan="3">
                                        <h:outputText value="#{request_doc.document.shortDescription}"/>
                                    </td>
                                </tr>
                                <tr class="row">
                                    <td class="first">
                                        <label>
                                            <span class="title">Адресаты-пользователи</span>
                                        </label>
                                    </td>
                                    <td class="second" colspan="3">
                                        <div class="width" style="overflow-y: scroll; height: 120px">
                                            <ui:repeat value="#{request_doc.document.recipientUserList}" var="recipientUser">
                                                <h:outputText value="#{recipientUser.getDescription()}" class="width"/><br/>
                                            </ui:repeat>
                                        </div>
                                    </td>
                                </tr>
                                <tr class="row">
                                    <td class="first">
                                        <label>
                                            <span class="title">Адресаты-группы</span>
                                        </label>
                                    </td>
                                    <td class="second" colspan="3">
                                        <div class="width" style="overflow-y: scroll; height: 120px">
                                            <ui:repeat value="#{request_doc.document.recipientGroupsList}" var="recipientGroup">
                                                <h:outputText value="#{recipientGroup.value}" class="width"/><br/>
                                            </ui:repeat>
                                        </div>
                                    </td>
                                </tr>
                                <tr class="row">
                                    <td class="first">
                                        <label>
                                            <span class="title">Номер в ERP</span>
                                        </label>
                                    </td>
                                    <td class="second">
                                        <h:outputText value="#{request_doc.document.erpNumber}"/>
                                    </td>
                                </tr>
                            </table>
                        </div>
                    </h:panelGroup>
                    <h:panelGroup rendered="#{request_doc.createState or request_doc.editState}">
                        <div class="row">
                            <table class="form_grid">
                                <tr class="row">
                                    <td class="first">
                                        <label for="deliveryType">
                                            <span class="title">Тип доставки: </span>
                                        </label>
                                    </td>
                                    <td class="second">
                                       <my:deliveryTypeSelectOneMenu id="deliveryType" value="#{request_doc.document.deliveryType}" style="width:15em;"/>
                                    </td>
                                    <td class="third"/>
                                    <td class="fourth"/>
                                </tr>
                                <tr class="row">
                                    <td class="first">
                                        <label for="senderType">
                                            <span class="title">Тип отправителя: </span>
                                        </label>
                                    </td>
                                    <td class="second">
                                        <p:selectOneMenu id="senderType" value="#{request_doc.document.senderType}"
                                                         converter="SenderTypeConverter"  style="width:15em;">
                                            <f:selectItems value="#{dictionaryManagement.senderTypes}"/>
                                            <f:ajax execute="senderType" render="content_table"/>
                                        </p:selectOneMenu>
                                    </td>
                                    <td class="third"/>
                                    <td class="fourth"/>
                                </tr>
                                <tr class="row">
                                    <td class="first">
                                        <p:commandLink actionListener="#{request_doc.chooseRegion}" ajax="true" value="Регион">
                                            <p:ajax event="dialogReturn" listener="#{request_doc.onRegionChosen}" update="region"/>
                                        </p:commandLink>
                                    </td>
                                    <td class="second">
                                        <h:outputText id="region" value="#{request_doc.document.region}" converter="RegionConverter"/>
                                    </td>
                                </tr>
                                <h:panelGroup rendered="#{request_doc.document.senderType.value.equals('Юридическое лицо')}">
                                    <tr class="row">
                                        <td class="first">
                                            <p:commandLink actionListener="#{request_doc.chooseContragent}" ajax="true" value="Корреспондент">
                                                <p:ajax event="dialogReturn" listener="#{request_doc.onContragentChosen}" update="contragent"/>
                                            </p:commandLink>
                                        </td>
                                        <td class="second" colspan="3">
                                            <h:outputText id="contragent" value="#{request_doc.document.contragent.value}" class="wide"/>
                                        </td>
                                    </tr>
                                </h:panelGroup>
                                <h:panelGroup rendered="#{request_doc.document.senderType.value.equals('Физическое лицо')or request_doc.document.senderType.value.equals('Юридическое лицо')}">
                                    <tr class="row">
                                        <td class="first">
                                            <label for="senderLastName">
                                                <span class="title">Фамилия:</span>
                                            </label>
                                        </td>
                                        <td class="second" colspan="3">
                                            <p:inputText id="senderLastName" value="#{request_doc.document.senderLastName}"/>
                                        </td>
                                    </tr>
                                    <tr class="row">
                                        <td class="first">
                                            <label for="senderFirstName">
                                                <span class="title">Имя:</span>
                                            </label>
                                        </td>
                                        <td class="second" colspan="3">
                                            <p:inputText id="senderFirstName" value="#{request_doc.document.senderFirstName}"/>
                                        </td>
                                    </tr>
                                    <tr class="row">
                                        <td class="first">
                                            <label for="senderMiddleName">
                                                <span class="title">Отчество:</span>
                                            </label>
                                        </td>
                                        <td class="second" colspan="3">
                                            <p:inputText id="senderMiddleName" value="#{request_doc.document.senderMiddleName}"/>
                                        </td>
                                    </tr>
                                </h:panelGroup>
                                <tr class="row">
                                    <td class="first">
                                        <label for="shortDescription">
                                            <span class="title">Краткое содержание</span>
                                        </label>
                                    </td>
                                    <td class="second" colspan="3">
                                        <p:inputText id="shortDescription" value="#{request_doc.document.shortDescription}"/>
                                    </td>
                                </tr>
                                <tr class="row">
                                    <td class="first">
                                        <p:commandLink value="Адресаты-пользователи" actionListener="#{request_doc.chooseRecipients}" ajax="true">
                                            <p:ajax event="dialogReturn" listener="#{request_doc.onRecipientsChosen}" update="recipientUsers"/>
                                        </p:commandLink>
                                    </td>
                                    <td class="second" colspan="3">
                                        <div style="overflow-y: scroll; height: 120px">
                                            <h:panelGroup id="recipientUsers">
                                                <ui:repeat value="#{request_doc.document.recipientUserList}" var="recipientUser">
                                                    <h:outputText value="#{recipientUser.getDescription()}" class="width"/><br/>
                                                </ui:repeat>
                                            </h:panelGroup>
                                        </div>
                                    </td>
                                </tr>
                                <tr class="row">
                                    <td class="first">
                                        <p:commandLink value="Адресаты-группы" actionListener="#{request_doc.chooseRecipientGroups}" ajax="true">
                                            <p:ajax event="dialogReturn" listener="#{request_doc.onRecipientGroupsChosen}" update="recipientGroups"/>
                                        </p:commandLink>
                                    </td>
                                    <td class="second" colspan="3">
                                        <div style="overflow-y: scroll; height: 120px">
                                            <h:panelGroup id="recipientGroups">
                                                <ui:repeat value="#{request_doc.document.recipientGroupsList}" var="recipientGroup">
                                                    <h:outputText value="#{recipientGroup.value}" class="width"/><br/>
                                                </ui:repeat>
                                            </h:panelGroup>
                                        </div>
                                    </td>
                                </tr>
                                <tr class="row">
                                    <td class="first">
                                        <label>
                                            <span class="title">Номер в ERP</span>
                                        </label>
                                    </td>
                                    <td class="second">
                                        <p:inputText value="#{request_doc.document.erpNumber}"/>
                                    </td>
                                </tr>

                                <tr class="row">
                                </tr>
                            </table>
                        </div>
                    </h:panelGroup>
                </p:tab>
                <p:tab title="Движение документа" rendered="#{request_doc.viewState or request_doc.createState or request_doc.editState}">
                    <fieldset>
                        <legend>Поручения</legend>
                        <div class="actionbar">
                            <div class="menu">
                                <h:panelGroup rendered="#{request_doc.document.getDocumentStatus().getId()==2}">
                                    <div class="defbutton">
                                        <h:outputLink value="/component/task/task.xhtml" target="_blank">
                                            <h:graphicImage value="#{resource['images:newf_buttn_icon.png']}"/>
                                            Новое поручение
                                            <f:param name="docAction" value="create"/>
                                            <f:param name="rootDocumentId" value="#{request_doc.document.uniqueId}"/>
                                        </h:outputLink>
                                    </div>
                                </h:panelGroup>
                                <div class="defbutton">
                                    <h:commandLink action="#{request_doc.taskTreeHolder.refresh()}">
                                        <f:ajax render="task_table" onevent="function(data){if (data.status === 'success'){addRowHandlers(); } }"/>
                                        <h:graphicImage value="#{resource['images:button-refresh.png']}"/>
                                        Обновить
                                    </h:commandLink>
                                </div>
                                <div class="defbutton">
                                    <h:commandLink action="#{request_doc.taskTreeHolder.collapseAll()}">
                                        <h:graphicImage value="#{resource['images:minus.png']}"/>
                                        <f:ajax render="task_table" onevent="function(data){if (data.status === 'success'){addRowHandlers(); } }"/>
                                        Свернуть все
                                    </h:commandLink>
                                </div>
                                <div class="defbutton">
                                    <h:commandLink action="#{request_doc.taskTreeHolder.expandAll()}">
                                        <h:graphicImage value="#{resource['images:plus.png']}"/>
                                        <f:ajax render="task_table" onevent="function(data){if (data.status === 'success'){addRowHandlers(); } }"/>
                                        Развернуть все
                                    </h:commandLink>
                                </div>
                            </div>
                        </div>
                        <h:panelGroup>
                            <div style="height: 250px; width: 100%; margin: 0;">
                                <p:treeTable id="task_table"
                                             value="#{request_doc.taskTreeHolder.root}"
                                             var="row_task"
                                             style="width:100%; overflow-x:hidden;"
                                             selectionMode="single"
                                             emptyMessage="Записей нет"
                                             widgetVar="taskTableVar">
                                    <p:column headerText="Дата создания">
                                        <h:outputText value="#{row_task.creationDate}">
                                            <f:convertDateTime type="date" pattern="dd.MM.yyyy"/>
                                        </h:outputText>
                                    </p:column>
                                    <p:column headerText="Номер">
                                        <h:outputText value="#{row_task.taskNumber}"/>
                                    </p:column>
                                    <p:column headerText="Автор">
                                        <h:outputText value="#{row_task.author.getDescription()}"/>
                                    </p:column>
                                    <p:column headerText="Исполнитель">
                                        <ui:repeat value="#{row_task.executorsList}" var="executor">
                                            <h:outputText value="#{executor.getDescription()}"/><br/>
                                        </ui:repeat>
                                    </p:column>
                                    <p:column headerText="Срок исполнения">
                                        <h:outputText value="#{row_task.controlDate}">
                                            <f:convertDateTime type="date" pattern="dd.MM.yyyy"/>
                                        </h:outputText>
                                    </p:column>
                                    <p:column headerText="Содержание">
                                        <h:outputText value="#{row_task.shortDescription}"/>
                                    </p:column>
                                    <p:column headerText="Статус">
                                        <h:outputText value="#{row_task.getDocumentStatus().getName()}"/>
                                    </p:column>
                                    <p:column style="display:none;">
                                        <input type="hidden" value="#{row_task.id}"/>
                                    </p:column>
                                    <p:ajax event="expand" oncomplete="addRowHandlers()"/>
                                </p:treeTable>
                                <script type="text/javascript">
                                    function addRowHandlers() {
                                        console.log("refresh treetable row onclick handlers");
                                        var table_tree = document.getElementById(PrimeFaces.widgets.taskTableVar.id);
                                        var rows = table_tree.getElementsByClassName("task");
                                        for (var i = 0; i &lt; rows.length; i++) {
                                            var currentRow = rows[i];
                                            var createClickHandler = function (row) {
                                                return function () {
                                                    goToTask(row.lastChild.lastChild.value);
                                                };
                                            };
                                            document.getElementById(currentRow.id).className = document.getElementById(currentRow.id).className.replace('ui-state-highlight', '');
                                            currentRow.ondblclick = createClickHandler(currentRow);
                                        }
                                    }
                                    window.onload = addRowHandlers;
                                </script>
                            </div>
                        </h:panelGroup>
                    </fieldset>
                </p:tab>
                <p:tab title="Связи" rendered="#{request_doc.viewState or request_doc.createState or request_doc.editState}"/>
                <p:tab title="Доступ">
                <h:panelGroup rendered="#{request_doc.createState or request_doc.editState}">
                    <div class="row">
                        <table class="form_grid">
                            <tr class="row">
                                <td colspan="2">
                                    <fieldset>
                                        <legend>Пользователи</legend>
                                        <table class="form_grid">
                                            <tr class="row">
                                                <td class="first">
                                                    <p:commandButton value="Читатели" actionListener="#{request_doc.choosePersonReaders}">
                                                        <p:ajax event="dialogReturn" listener="#{request_doc.onPersonReadersChosen}" update="personReaders"/>
                                                    </p:commandButton>
                                                </td>
                                                <td class="second" colspan="3">
                                                    <div style="overflow-y: scroll; height: 90px">
                                                        <h:panelGroup id="personReaders">
                                                            <ui:repeat value="#{request_doc.document.personReadersList}" var="personReader">
                                                                <h:outputText value="#{personReader.getDescription()}" class="width"/><br/>
                                                            </ui:repeat>
                                                        </h:panelGroup>
                                                    </div>
                                                </td>
                                            </tr>
                                            <tr class="row">
                                                <td class="first">
                                                    <p:commandButton value="Редакторы" actionListener="#{request_doc.choosePersonEditors}">
                                                        <p:ajax event="dialogReturn" listener="#{request_doc.onPersonEditorsChosen}" update="personEditors"/>
                                                    </p:commandButton>
                                                </td>
                                                <td class="second" colspan="3">
                                                    <div style="overflow-y: scroll; height: 90px">
                                                        <h:panelGroup id="personEditors">
                                                            <ui:repeat value="#{request_doc.document.personEditorsList}" var="personEditor">
                                                                <h:outputText value="#{personEditor.getDescription()}" class="width"/><br/>
                                                            </ui:repeat>
                                                        </h:panelGroup>
                                                    </div>
                                                </td>
                                            </tr>
                                            <tr class="row">
                                                <td class="first"/>
                                                <td class="second"/>
                                                <td class="third"/>
                                                <td class="fourth"/>
                                            </tr>
                                        </table>
                                    </fieldset>
                                </td>
                                <td colspan="2">
                                    <fieldset>
                                        <legend>Роли</legend>
                                        <table class="form_grid">
                                            <tr class="row">
                                                <td class="first">
                                                    <p:commandButton value="Читатели" actionListener="#{request_doc.chooseRoleReaders}">
                                                        <p:ajax event="dialogReturn" listener="#{request_doc.onRoleReadersChosen}" update="roleReaders"/>
                                                    </p:commandButton>
                                                </td>
                                                <td class="second" colspan="3">
                                                    <div style="overflow-y: scroll; height: 90px">
                                                        <h:panelGroup id="roleReaders">
                                                            <ui:repeat value="#{request_doc.document.roleReadersList}" var="roleReader">
                                                                <h:outputText value="#{roleReader.name}" class="width"/><br/>
                                                            </ui:repeat>
                                                        </h:panelGroup>
                                                    </div>
                                                </td>
                                            </tr>
                                            <tr class="row">
                                                <td class="first">
                                                    <p:commandButton value="Редакторы" actionListener="#{request_doc.chooseRoleEditors}">
                                                        <p:ajax event="dialogReturn" listener="#{request_doc.onRoleEditorsChosen}" update="roleEditors"/>
                                                    </p:commandButton>
                                                </td>
                                                <td class="second" colspan="3">
                                                    <div style="overflow-y: scroll; height: 90px">
                                                        <h:panelGroup id="roleEditors">
                                                            <ui:repeat value="#{request_doc.document.roleEditorsList}" var="roleEditor">
                                                                <h:outputText value="#{roleEditor.name}" class="width"/><br/>
                                                            </ui:repeat>
                                                        </h:panelGroup>
                                                    </div>
                                                </td>
                                            </tr>
                                            <tr class="row"/>
                                        </table>
                                    </fieldset>
                                </td>
                            </tr>
                            <tr class="row"/>
                        </table>
                    </div>
                </h:panelGroup>

                <h:panelGroup rendered="#{request_doc.viewState}">
                    <div class="row">
                        <table class="form_grid">
                            <tr class="row">
                                <td colspan="2">
                                    <fieldset>
                                        <legend>Пользователи</legend>
                                        <table class="form_grid">
                                            <tr class="row">
                                                <td class="first">
                                                    Читатели:
                                                </td>
                                                <td class="second" colspan="3">
                                                    <div style="overflow-y: scroll; height: 90px">
                                                        <ui:repeat value="#{request_doc.document.personReadersList}" var="personReader">
                                                            <h:outputText value="#{personReader.getDescription()}" class="width"/><br/>
                                                        </ui:repeat>
                                                    </div>
                                                </td>
                                            </tr>
                                            <tr class="row">
                                                <td class="first">
                                                    <span class="title">Редакторы: </span>
                                                </td>
                                                <td class="second" colspan="3">
                                                    <div style="overflow-y: scroll; height: 90px">
                                                        <ui:repeat value="#{request_doc.document.personEditorsList}" var="personEditor">
                                                            <h:outputText value="#{personEditor.getDescription()}" class="width"/><br/>
                                                        </ui:repeat>
                                                    </div>
                                                </td>
                                            </tr>
                                        </table>
                                    </fieldset>
                                </td>
                                <td colspan="2">
                                    <fieldset>
                                        <legend>Роли</legend>
                                        <table class="form_grid">
                                            <tr class="row">
                                                <td class="first">
                                                    <span class="title">На чтение: </span>
                                                </td>
                                                <td class="second" colspan="3">
                                                    <div style="overflow-y: scroll; height: 90px">
                                                        <ui:repeat value="#{request_doc.document.roleReadersList}" var="roleReader">
                                                            <h:outputText value="#{roleReader.name}" class="width"/><br/>
                                                        </ui:repeat>
                                                    </div>
                                                </td>
                                            </tr>
                                            <tr class="row">
                                                <td class="first">
                                                    <label>
                                                        <span class="title">На редактирование:</span>
                                                    </label>
                                                </td>
                                                <td class="second" colspan="3">
                                                    <div style="overflow-y: scroll; height: 90px">
                                                        <ui:repeat value="#{request_doc.document.roleEditorsList}" var="roleEditor">
                                                            <h:outputText value="#{roleEditor.name}" class="width"/><br/>
                                                        </ui:repeat>
                                                    </div>
                                                </td>
                                            </tr>
                                        </table>
                                    </fieldset>
                                </td>
                            </tr>
                        </table>
                    </div>
                </h:panelGroup>
            </p:tab>
                <p:tab title="История" rendered="#{request_doc.viewState or request_doc.createState or request_doc.editState}">
                    <my:historyTable id ="historyTable" value ="#{request_doc.document.historyList}"/>
                </p:tab>
            </p:tabView>
        </div>
    </ui:define>

    <ui:define name="footer">
        <h:form id="file_upload_form" enctype="multipart/form-data">
            <div style="padding-top: 10px;">
                <fieldset>
                    <legend>Файлы</legend>
                    <div class="menu">
                        <div class="defbutton">
                            <e5ui:fileUpload id="file_upload" multiple="true"
                                             actionBehavior="separate" maxFilesCount="0"
                                             uploadHandler="#{fileManagement.uploadHandler}"
                                             action="#{request_doc.uploadAttachments(fileManagement.details)}"
                                             onuploading="e5ui_ajaxStatus.ajsgStopped=true;splash_screen_2.startShow();"
                                             onuploaded="splash_screen_2.stopShow();e5ui_ajaxStatus.ajsgStopped=false;">
                                <f:ajax render=":file_upload_form"/>
                            </e5ui:fileUpload>
                        </div>
                        <div class="defbutton">
                            <h:commandLink action="#{request_doc.updateAttachments()}">
                                <h:graphicImage value="#{resource['images:button-refresh.png']}"/>
                                Обновить
                                <f:ajax render=":file_upload_form"/>
                            </h:commandLink>
                        </div>
                    </div>
                    <div style="margin-top: 10px;">
                        <div class="wrap_main" id="table_wrap">
                            <div class="inner" id="table_inner">
                                <e5ui:dataTable border="0" cellpadding="0" cellspacing="0"
                                                id="file_table" value="#{request_doc.attachments}" var="row">
                                    <e5ui:column>
                                        <h:outputText value="#{row.currentRevision.fileName}"/>
                                    </e5ui:column>
                                    <e5ui:column>
                                        <h:outputText value="#{row.currentRevision.version}"/>
                                    </e5ui:column>
                                    <e5ui:column>
                                        <h:outputText
                                                value="#{userList.getUserFullNameById(row.currentRevision.authorId)}"/>
                                    </e5ui:column>
                                    <e5ui:column>
                                        <h:outputLink
                                                value="/component/file/download.xhtml"
                                                target="_blank">
                                            <h:graphicImage value="/resources/images/download_doc.gif"/>
                                            <f:param name="id" value="#{row.id}"/>
                                            Скачать
                                        </h:outputLink>
                                    </e5ui:column>
                                    <e5ui:column>
                                        <h:commandLink
                                                action="#{request_doc.initializeVersionAppender(row)}">
                                            <h:graphicImage value="/resources/images/CheckOut_icon.gif"/>
                                            <f:ajax render=":file_upload_form"/>
                                            Добавить версию документа
                                        </h:commandLink>
                                    </e5ui:column>
                                    <e5ui:column>
                                        <h:commandLink
                                                action="#{request_doc.initializeVersionHistory(row)}">
                                            <h:graphicImage value="/resources/images/CheckOut_icon.gif"/>
                                            <f:ajax render=":file_upload_form"/>
                                            История версий
                                        </h:commandLink>
                                    </e5ui:column>
                                    <e5ui:column>
                                        <h:commandLink action="#{request_doc.deleteAttachment(row)}">
                                            <h:graphicImage value="/resources/images/delete.gif"/>
                                            <f:ajax render=":file_upload_form"/>
                                            Удалить
                                        </h:commandLink>
                                    </e5ui:column>
                                </e5ui:dataTable>

                                <e5ui-comp:modalWindow id="versionAppenderModal"
                                                       modalWindowHolder="#{request_doc.versionAppenderModal}"
                                                       render=":file_upload_form" execute=":file_upload_form"
                                                       style="width:300px;" showButtons="false"
                                                       widgetVar="versionAppenderModal">
                                    <div id="title">Добавление версии документа</div>
                                    <div id="modal_container" style="margin-top: 0;">
                                        <div>
                                            Документ:
                                            <h:outputText
                                                    value="#{request_doc.versionAppenderModal.attachment.currentRevision.fileName}"/>
                                        </div>
                                        <div>
                                            Текущая версия:
                                            <h:outputText
                                                    value="#{request_doc.versionAppenderModal.attachment.currentRevision.version}"/>
                                        </div>
                                        <div>
                                            <h:selectBooleanCheckbox
                                                    value="#{request_doc.versionAppenderModal.majorVersion}"/>
                                            Увеличить старший номер
                                        </div>
                                        <div style="margin-top: 5px;">
                                            <e5ui:fileUpload id="version_upload" multiple="false"
                                                             actionBehavior="separate" maxFilesCount="1"
                                                             uploadHandler="#{fileManagement.uploadHandler}"
                                                             action="#{request_doc.versionAppenderModal.saveAttachment}"
                                                             onuploading="e5ui_ajaxStatus.ajsgStopped=true;splash_screen_2.startShow();"
                                                             onuploaded="splash_screen_2.stopShow();e5ui_ajaxStatus.ajsgStopped=false;">
                                                <f:ajax render=":file_upload_form"
                                                        execute=":file_upload_form:versionAppenderModal"/>
                                            </e5ui:fileUpload>
                                        </div>
                                    </div>
                                    <div class="e5ui-modal-bottombuttons">
                                        <h:button
                                                onclick="versionAppenderModal.clickClose(); return false;"
                                                value="Отмена"/>
                                    </div>
                                </e5ui-comp:modalWindow>

                                <e5ui-comp:modalWindow id="versionHistoryModal"
                                                       modalWindowHolder="#{request_doc.versionHistoryModal}"
                                                       render=":file_upload_form" execute=":file_upload_form"
                                                       style="width:500px;" showButtons="false"
                                                       widgetVar="versionHistoryModal">
                                    <div id="title">История версий документа</div>
                                    <div id="modal_container" style="margin-top: 0;">
                                        <div class="wrap_main" id="table_wrap">
                                            <div class="inner" id="table_inner">
                                                <e5ui:dataTable border="0" cellpadding="0" cellspacing="0"
                                                                id="version_table"
                                                                value="#{request_doc.versionHistoryModal.versionList}"
                                                                var="row">
                                                    <e5ui:column style="min-width:8em;">
                                                        <h:outputText
                                                                value="#{row.fileName eq null? request_doc.versionHistoryModal.attachment.fileName: row.fileName}"/>
                                                    </e5ui:column>
                                                    <e5ui:column style="min-width:5em;">
                                                        <h:outputText value="#{row.version}"/>
                                                    </e5ui:column>
                                                    <e5ui:column style="min-width:12em;">
                                                        <h:outputText
                                                                value="#{userList.getUserFullNameById(row.authorId eq 0? request_doc.versionHistoryModal.attachment.authorId: row.authorId)}"/>
                                                    </e5ui:column>
                                                    <e5ui:column style="min-width:7em;">
                                                        <h:outputLink
                                                                value="/component/file/download.xhtml"
                                                                target="_blank">
                                                            <h:graphicImage
                                                                    value="/resources/images/download_doc.gif"/>
                                                            <f:param name="id"
                                                                     value="#{request_doc.versionHistoryModal.attachment.id}"/>
                                                            <f:param name="revision" value="#{row.version}"/>
                                                            Скачать
                                                        </h:outputLink>
                                                    </e5ui:column>
                                                </e5ui:dataTable>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="e5ui-modal-bottombuttons">
                                        <h:button onclick="versionHistoryModal.clickClose(); return false;"
                                                  value="Закрыть"/>
                                    </div>
                                </e5ui-comp:modalWindow>
                            </div>
                        </div>
                    </div>
                </fieldset>
            </div>
            <e5ui-comp:splashScreen id="splash_screen_2"
                                    widgetVar="splash_screen_2" timeout="0">
                <f:facet name="timeoutPanel">
                    <div
                            style="background-color: white; border-top: solid 1px black; border-bottom: solid 1px black; padding: 30px; text-align: center; margin: 200px auto; width: 300px;">
                        Пожалуйста, подождите...
                    </div>
                </f:facet>
            </e5ui-comp:splashScreen>
            <script>
                e5ui_splashScreen.startShowOnSubmit('splash_screen_2',
                        ['file_upload_form']);
            </script>
        </h:form>
        <h:outputStylesheet library="css" name="datatable.css"/>
        <h:outputStylesheet library="css" name="modalWindow.css"/>
    </ui:define>

</ui:composition>

</html>